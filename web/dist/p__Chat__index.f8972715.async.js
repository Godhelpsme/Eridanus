"use strict";(self.webpackChunkant_design_pro=self.webpackChunkant_design_pro||[]).push([[570],{67179:function(Ge,k,o){o.r(k),o.d(k,{default:function(){return xe}});var te=o(97857),b=o.n(te),ae=o(19632),x=o.n(ae),oe=o(64599),V=o.n(oe),ie=o(15009),y=o.n(ie),le=o(99289),w=o.n(le),ue=o(5574),O=o.n(ue),C=o(67294),se=o(9361),de=o(42075),Y=o(74330),ce=o(91439),F=o(2453),fe=o(4393),ve=o(83622),X=o(16596),pe=o(76654),he=o(45311),Se=o(39559),E={container:"container___PlbYR",chatCard:"chatCard___Xx0Vw",chatContainer:"chatContainer___SP6io",message:"message___XLm3g",userMessage:"userMessage___Wp0tl",serverMessage:"serverMessage___GAfYU",bottomTools:"bottomTools___GZxgP",uploadButton:"uploadButton___h6D76",sendButton:"sendButton___gOHpp"},ye=o(2618),u=o(85893),Ce="/api/ws",Je="",ge=function(){var je=(0,C.useState)([]),K=O()(je,2),G=K[0],v=K[1],Me=(0,C.useState)(null),Q=O()(Me,2),c=Q[0],We=Q[1],be=C.useState(!1),I=O()(be,2),Fe=I[0],J=I[1],N=(0,C.useRef)(null),$=C.useRef(null),Re=se.Z.useToken(),q=Re.token,He=q.colorBgContainer,ke=q.borderRadiusLG,me=(0,C.useState)(""),_=O()(me,2),Te=_[0],ee=_[1];(0,C.useEffect)(function(){return J(!0),Be(),function(){c&&c.close()}},[]),(0,C.useEffect)(function(){ne()},[G]);var Be=function a(){var n=new WebSocket(Ce);n.onopen=function(){J(!1),L("WebSocket \u5DF2\u8FDE\u63A5\uFF01")},n.onmessage=function(e){Ue(e.data)},n.onclose=function(){window.location.pathname=="/chat"&&(J(!0),setTimeout(a,5e3))},n.onerror=function(e){L("WebSocket \u8FDE\u63A5\u9519\u8BEF")},We(n)},Ze=function(n,e,t,r){return console.log("renderBubble\u88AB\u8C03\u7528\uFF0CreplyTo:",r),(0,u.jsxs)("div",{children:[r!=null&&r.content?(0,u.jsx)("div",{style:{padding:"5px",backgroundColor:"#f0f0f0",borderRadius:"4px",marginBottom:"8px",fontSize:"12px",color:"#666"},children:(0,u.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"8px"},children:r.content.length>50?"".concat(r.content.substring(0,50),"..."):r.content})}):null,n?"".concat(n):"",t?(0,u.jsx)("div",{style:{padding:"10px",textAlign:"center"},children:(0,u.jsxs)(de.Z,{children:[(0,u.jsx)(Y.Z,{size:"small"}),(0,u.jsx)("span",{children:"\u52A0\u8F7D\u4E2D..."})]})}):e?(0,u.jsx)("div",{children:e.startsWith("data:image")?(0,u.jsx)(ce.Z,{src:e,style:{maxWidth:"200px",cursor:"pointer"}}):e.startsWith("data:video")?(0,u.jsx)("video",{src:e,controls:!0,style:{maxWidth:"200px"}}):e.startsWith("data:audio")?(0,u.jsx)("audio",{src:e,controls:!0,style:{width:"200px"}}):(0,u.jsx)("div",{children:"\u4E0D\u652F\u6301\u7684\u5A92\u4F53\u7C7B\u578B"})}):""]})},Le=function(){var a=w()(y()().mark(function n(e){return y()().wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,(0,ye.vT)(JSON.stringify({path:e})).then(function(s){return s.base64?s.base64:null}).catch(function(s){return null});case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}},n)}));return function(e){return a.apply(this,arguments)}}(),Ve=function(){var a=w()(y()().mark(function n(e){var t,r,s,d;return y()().wrap(function(l){for(;;)switch(l.prev=l.next){case 0:if(t=e.target.files,!(!t||t.length===0)){l.next=3;break}return l.abrupt("return");case 3:r=V()(t),l.prev=4,d=y()().mark(function f(){var h,j;return y()().wrap(function(g){for(;;)switch(g.prev=g.next){case 0:h=s.value,j=new FileReader,j.onload=function(){var R=w()(y()().mark(function m(U){var M,T,B,i,Z;return y()().wrap(function(W){for(;;)switch(W.prev=W.next){case 0:console.log("\u6587\u4EF6\u8BFB\u53D6\u5B8C\u6210 (handleFileUpload)"),T=(M=U.target)===null||M===void 0?void 0:M.result,B=h.type,i=h.type.split("/")[0],c&&c.readyState===WebSocket.OPEN?(Z={type:i,data:{file:T,mime:B}},c.send(JSON.stringify([Z])),z("[".concat(h.name,"]"))):F.ZP.error("WebSocket \u8FDE\u63A5\u672A\u5C31\u7EEA");case 5:case"end":return W.stop()}},m)}));return function(m){return R.apply(this,arguments)}}(),j.onerror=function(R){console.error("\u6587\u4EF6\u8BFB\u53D6\u9519\u8BEF (handleFileUpload):",R),F.ZP.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},console.log("\u5F00\u59CB\u8BFB\u53D6\u6587\u4EF6:",h.name),j.readAsDataURL(h);case 6:case"end":return g.stop()}},f)}),r.s();case 7:if((s=r.n()).done){l.next=11;break}return l.delegateYield(d(),"t0",9);case 9:l.next=7;break;case 11:l.next=16;break;case 13:l.prev=13,l.t1=l.catch(4),r.e(l.t1);case 16:return l.prev=16,r.f(),l.finish(16);case 19:case"end":return l.stop()}},n,null,[[4,13,16,19]])}));return function(e){return a.apply(this,arguments)}}(),Ue=function(n){try{var e,t=JSON.parse(n);if(!((e=t.message)!==null&&e!==void 0&&e.params)){console.warn("\u6536\u5230\u65E0\u6548\u6D88\u606F:",t);return}var r=t.message.params.messages||t.message.params.message;if(!Array.isArray(r)){console.warn("\u6D88\u606F\u683C\u5F0F\u9519\u8BEF:",r);return}var s=Date.now().toString(),d,p=[],l=!1,f,h=r.find(function(S){var A;return S.type==="reply"&&((A=S.data)===null||A===void 0?void 0:A.id)});if(h){var j=h.data.id,re=Ae(j);d={id:j,content:re}}var g=V()(r),R;try{for(g.s();!(R=g.n()).done;){var m,U,M,T,B,i=R.value;if(i.type==="text"&&(m=i.data)!==null&&m!==void 0&&m.text)p.push(i.data.text);else if(i.type==="image"){var Z,D,W;l=!0,(Z=i.data)!==null&&Z!==void 0&&Z.url?f=i.data.url:(D=i.data)!==null&&D!==void 0&&D.file&&typeof i.data.file=="string"&&i.data.file.startsWith("data:")?f=i.data.file:(W=i.data)!==null&&W!==void 0&&W.file&&typeof i.data.file=="string"&&Le(i.data.file).then(function(S){if(S)De(s,S);else{var A=p.join(`
`).replace("[\u56FE\u7247\u52A0\u8F7D\u4E2D...]","[\u56FE\u7247\u52A0\u8F7D\u5931\u8D25]");Pe(s,A)}})}else if(i.type==="video"&&((U=i.data)!==null&&U!==void 0&&U.file||(M=i.data)!==null&&M!==void 0&&M.url))p.push("[\u89C6\u9891] ".concat(i.data.name||""));else if(i.type==="audio"&&((T=i.data)!==null&&T!==void 0&&T.file||(B=i.data)!==null&&B!==void 0&&B.url))p.push("[\u97F3\u9891] ".concat(i.data.name||""));else if(i.type==="file"){var H;p.push("[\u6587\u4EF6] ".concat(((H=i.data)===null||H===void 0?void 0:H.name)||""))}else i.type!=="reply"&&p.push("\u672A\u77E5\u6D88\u606F\u7C7B\u578B: ".concat(i.type))}}catch(S){g.e(S)}finally{g.f()}var P=p.join(`
`);l&&f?Ee(s,P,f,d):l?Ne(s,P,d):d?Oe(P,d):L(P)}catch(S){L("\u89E3\u6790\u670D\u52A1\u5668\u6D88\u606F\u5931\u8D25: "+S),L("[\u6D88\u606F\u683C\u5F0F\u65E0\u6548]")}},Ae=function(n){var e=G.find(function(t){return t.id===n});return(e==null?void 0:e.content)||"\u539F\u6D88\u606F\u4E0D\u53EF\u7528"},z=function(n){var e=Date.now().toString();v(function(t){return[].concat(x()(t),[{role:"end",content:n,id:e}])})},L=function(n){var e=Date.now().toString();v(function(t){return[].concat(x()(t),[{role:"start",content:n,id:e}])})},Oe=function(n,e){var t=Date.now().toString();v(function(r){return[].concat(x()(r),[{role:"start",content:n,id:t,replyTo:e}])})},Ye=function(n){v(function(e){return[].concat(x()(e),[{role:"start",loading:!0,id:n}])})},Ee=function(n,e,t,r){v(function(s){return[].concat(x()(s),[{role:"start",content:e,base64:t,id:n,replyTo:r}])})},Ne=function(n,e,t){v(function(r){return[].concat(x()(r),[{role:"start",content:e,loading:!0,id:n,replyTo:t}])})},De=function(n,e){v(function(t){return t.map(function(r){return r.id===n?b()(b()({},r),{},{base64:e,loading:!1}):r})}),ne()},Pe=function(n,e){v(function(t){return t.map(function(r){return r.id===n?b()(b()({},r),{},{content:e,loading:!1}):r})})},Xe=function(n){v(function(e){return e.map(function(t){return t.id===n?b()(b()({},t),{},{content:"\u56FE\u7247\u52A0\u8F7D\u5931\u8D25",loading:!1}):t})})},Ke=function(n){v(function(e){return[].concat(x()(e),[{role:"start",base64:n}])})},ne=function(){N.current&&(N.current.scrollTop=N.current.scrollHeight)},we=function(n){n.trim()&&(c&&c.readyState===WebSocket.OPEN?(z(n),c.send(JSON.stringify([{type:"text",data:{text:n}}])),ee(""),setTimeout(function(){},10)):F.ZP.error("WebSocket \u672A\u8FDE\u63A5"))};return(0,u.jsx)(Y.Z,{spinning:Fe,tip:"websocket\u8FDE\u63A5\u4E2D...",size:"large",children:(0,u.jsxs)(fe.Z,{className:E.chatCard,ref:$,children:[(0,u.jsx)("div",{className:E.chatContainer,ref:N,children:G.map(function(a,n){return(0,u.jsx)(pe.Z,{placement:a.role,shape:"corner",className:E.message,messageRender:function(){return Ze(a.content,a.base64,a.loading,a.replyTo)}},n)})}),(0,u.jsx)(he.Z,{placeholder:"\u8BF7\u8F93\u5165...",className:E.bottomTools,value:Te,autoSize:!0,onChange:function(n){ee(n)},onSubmit:function(n){we(n)},prefix:(0,u.jsx)(u.Fragment,{children:(0,u.jsx)(Se.Z,{beforeUpload:function(){return!1},onChange:function(n){if(!n.file.originFileObj){console.error("\u6587\u4EF6\u5BF9\u8C61\u4E0D\u5B58\u5728"),F.ZP.error("\u6587\u4EF6\u4E0A\u4F20\u5931\u8D25\uFF1A\u65E0\u6CD5\u83B7\u53D6\u6587\u4EF6");return}var e=n.file.originFileObj;console.log("\u6587\u4EF6\u4E0A\u4F20:",e.name,e.type);var t=new FileReader;t.onload=function(r){var s;console.log("\u6587\u4EF6\u8BFB\u53D6\u5B8C\u6210");var d=(s=r.target)===null||s===void 0?void 0:s.result,p=e.type,l=e.type.split("/")[0];if(c&&c.readyState===WebSocket.OPEN){var f;l==="image"?f={type:l,data:{url:d,file:e.name}}:l==="video"||l==="audio"?f={type:l,data:{file:d}}:f={type:"file",data:{name:e.name,content:d}},c.send(JSON.stringify([f])),z("[".concat(e.name,"]"))}else F.ZP.error("WebSocket \u8FDE\u63A5\u672A\u5C31\u7EEA")},t.onerror=function(r){console.error("\u6587\u4EF6\u8BFB\u53D6\u9519\u8BEF:",r),F.ZP.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},t.readAsDataURL(e)},getDropContainer:function(){return $.current},maxCount:5,multiple:!0,showUploadList:!1,placeholder:{icon:(0,u.jsx)(X.Z,{}),title:"\u677E\u5F00\u4E0A\u4F20",description:"\u652F\u6301\u6587\u4EF6\uFF1A\u56FE\u7247\u3001\u89C6\u9891\u3001\u97F3\u9891\u7B49"},children:(0,u.jsx)(ve.ZP,{type:"text",icon:(0,u.jsx)(X.Z,{})})})})})]})})},xe=ge}}]);
