"use strict";(self.webpackChunkant_design_pro=self.webpackChunkant_design_pro||[]).push([[570],{30778:function(qe,K,n){n.r(K),n.d(K,{default:function(){return De}});var ge=n(19632),Q=n.n(ge),pe=n(64599),he=n.n(pe),me=n(15009),C=n.n(me),xe=n(99289),O=n.n(xe),ye=n(5574),x=n.n(ye),u=n(67294),w=n(2453),H=n(74330),Se=n(4393),X=n(86250),je=n(72269),Ce=n(83622),q=n(16596),be=n(76654),Re=n(45311),Ze=n(73869),_=n(76772),I=n(71471),ee=n(95715),Fe=n(10048),we=n(2618),t=n(85893),Te=(0,Fe.Z)({html:!0,breaks:!0}),te="",Le=function(e,v,h,o,b){var Z=(0,u.useState)(null),d=x()(Z,2),c=d[0],f=d[1],y=(0,u.useState)(!0),E=x()(y,2),P=E[0],T=E[1],S=(0,u.useState)(null),L=x()(S,2),W=L[0],k=L[1];return(0,u.useEffect)(function(){var m=function(){var $=O()(C()().mark(function F(){var j;return C()().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(i.prev=0,e!="custom"){i.next=5;break}f({desc:"",musicUrl:h,title:b,preview:o}),i.next=9;break;case 5:return i.next=7,(0,we.Hv)({type:e,id:v});case 7:j=i.sent,j?(f(j),console.info(j)):k("\u672A\u83B7\u53D6\u5230\u97F3\u4E50\u4FE1\u606F");case 9:i.next=16;break;case 11:i.prev=11,i.t0=i.catch(0),console.error("\u83B7\u53D6\u97F3\u4E50\u4FE1\u606F\u5931\u8D25:",i.t0),k(i.t0.message||"\u83B7\u53D6\u97F3\u4E50\u4FE1\u606F\u5931\u8D25"),w.ZP.error("\u83B7\u53D6\u97F3\u4E50\u4FE1\u606F\u5931\u8D25");case 16:return i.prev=16,T(!1),i.finish(16);case 19:case"end":return i.stop()}},F,null,[[0,11,16,19]])}));return function(){return $.apply(this,arguments)}}();m()},[e,v]),P?(0,t.jsx)(H.Z,{}):W?(0,t.jsx)(I.Z,{children:W}):c?(0,t.jsx)(I.Z,{style:{width:400,maxWidth:"100%"},children:(0,t.jsxs)("div",{style:{display:"flex",alignItems:"center"},children:[(0,t.jsx)(ee.Z,{src:c.preview||"https://picsum.photos/64/64",height:114,style:{borderRadius:"6px"}}),(0,t.jsxs)("div",{style:{marginLeft:12,flex:1},children:[(0,t.jsx)(I.Z.Title,{level:5,style:{margin:0},children:c.title||"\u672A\u77E5\u6807\u9898"}),(0,t.jsx)(I.Z.Text,{type:"secondary",children:c.desc||"\u65E0\u63CF\u8FF0"}),(0,t.jsx)("audio",{src:c.musicUrl||"",controls:!0,style:{width:"100%",marginTop:4}})]})]})}):(0,t.jsx)(I.Z,{children:"\u6CA1\u6709\u627E\u5230\u97F3\u4E50\u4FE1\u606F"})},_e=function(e){var v=Typography.Text,h=Typography.Title;if(!e)return _jsx("div",{children:"\u8F6C\u53D1\u6D88\u606F\u6570\u636E\u65E0\u6548"});var o=[],b="\u8F6C\u53D1\u6D88\u606F";return e.message&&e.message.params&&e.message.params.messages?(o=e.message.params.messages,o.length>0&&o[0].data&&o[0].data.nickname&&(b=o[0].data.nickname)):e.data&&e.data.content?(o=[{data:{content:e.data.content}}],e.data.nickname&&(b=e.data.nickname)):Array.isArray(e)&&(o=e),o.length===0?_jsx("div",{children:"\u8F6C\u53D1\u6D88\u606F\u6570\u636E\u65E0\u6548"}):_jsx(Card,{title:b,style:{marginTop:10,maxWidth:"100%",backgroundColor:"#f9f9f9"},size:"small",bordered:!0,children:_jsx(List,{itemLayout:"vertical",dataSource:o,renderItem:function(d){if(d.type==="node"&&d.data){var c=d.data.content||[];return _jsxs(List.Item,{children:[d.data.nickname&&_jsx("div",{style:{fontWeight:"bold",marginBottom:"4px"},children:d.data.nickname}),c.map(function(f,y){return f.type==="text"&&f.data&&f.data.text?_jsx("div",{style:{whiteSpace:"pre-wrap",fontSize:"14px"},children:f.data.text},y):null})]})}else if(d.type==="text"&&d.data&&d.data.text)return _jsx(List.Item,{children:_jsx("div",{style:{whiteSpace:"pre-wrap",fontSize:"14px"},children:d.data.text})});return null},split:!0})})},ke=function(e){return(0,t.jsx)("video",{src:e,controls:!0,style:{maxWidth:"300px"}})},Me=function(e){var v=(0,u.useState)(!0),h=x()(v,2),o=h[0],b=h[1],Z=(0,u.useState)(!1),d=x()(Z,2),c=d[0],f=d[1];return(0,t.jsx)(H.Z,{spinning:o,children:(0,t.jsx)(ee.Z,{src:e,onLoad:function(){return b(!1)},style:{maxWidth:"150px",cursor:"pointer"}})})},Ie=function(e){return(0,t.jsx)("audio",{src:e,controls:!0,style:{width:"200px"}})},Ee=function(e){return e?(0,t.jsx)("div",{style:{padding:"5px",backgroundColor:"transparent",borderRadius:"4px",marginBottom:"8px",fontSize:"12px"},children:(0,t.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"8px"},children:e.length>50?"".concat(e.substring(0,50),"..."):e})}):null},We=function(e,v){return(0,t.jsxs)("a",{href:e,target:"_blank",children:["\u70B9\u51FB\u4E0B\u8F7D\uFF1A",v]})},$e=function(e,v){return(0,t.jsx)(I.Z,{children:v=="start"?(0,t.jsx)("div",{dangerouslySetInnerHTML:{__html:Te.render(e)}}):(0,t.jsx)("div",{children:e})})},Be=function(e){var v,h,o,b=e.role,Z=e.replyContent,d=e.message_id,c=e.message,f=(0,_.useModel)("@@initialState"),y=f.initialState,E=f.setInitialState,P=y==null||(v=y.settings)===null||v===void 0?void 0:v.isDark,T=c.action,S=(h=c.params)===null||h===void 0?void 0:h.messages,L=(o=c.params)===null||o===void 0?void 0:o.message;switch(console.info(T),T){case"send_group_msg":if(L){var W=L.map(function(m,$){var F,j,M,i;if(m.type=="text")return $e(m.data.text,b);var A="".concat(te,"/api/chat/file?path=").concat(m.data.file);switch(m.type){case"music":return Le(m.data.type,(F=m.data)===null||F===void 0?void 0:F.id,(j=m.data)===null||j===void 0?void 0:j.audio,(M=m.data)===null||M===void 0?void 0:M.image,(i=m.data)===null||i===void 0?void 0:i.title);case"image":return Me(A);case"video":return ke(A);case"record":return Ie(A);case"reply":return Ee(Z);case"at":return"@\u4F60";default:return"[\u6682\u4E0D\u652F\u6301\u7684\u6D88\u606F\u7C7B\u578B]"}});return(0,t.jsx)("div",{children:W})}case"upload_group_file":console.info(c.params);var k="".concat(te,"/api/chat/file?path=").concat(c.params.file);return We(k,c.params.name);case"delete_msg":return"[\u6D88\u606F\u64A4\u56DE\u4E8B\u4EF6]"}return null},Ue=Be,Ae=n(64593),Oe="/api/ws",Pe="",ze=function(){var e,v=u.useRef(null),h=(0,_.useModel)("@@initialState"),o=h.initialState,b=h.setInitialState,Z=o==null||(e=o.settings)===null||e===void 0?void 0:e.isDark,d=(0,u.useState)([]),c=x()(d,2),f=c[0],y=c[1],E=(0,u.useRef)([]),P=(0,u.useState)(null),T=x()(P,2),S=T[0],L=T[1],W=u.useState(!1),k=x()(W,2),m=k[0],$=k[1],F=u.useState(!0),j=x()(F,2),M=j[0],i=j[1],A=u.useState(!0),re=x()(A,2),et=re[0],ae=re[1],z=(0,u.useRef)(null),ne=u.useRef(null),He=(0,u.useState)(""),se=x()(He,2),Ne=se[0],N=se[1],tt=function(){console.log("Current messages:",f),f.forEach(function(r,a){console.log("Message ".concat(a,":"),r)})};(0,u.useEffect)(function(){var s=function(){var r=O()(C()().mark(function a(){return C()().wrap(function(g){for(;;)switch(g.prev=g.next){case 0:ae(!0);try{}catch(B){console.error("\u52A0\u8F7D\u5386\u53F2\u6D88\u606F\u5931\u8D25:",B)}finally{ae(!1),$(!0),Ve()}case 2:case"end":return g.stop()}},a)}));return function(){return r.apply(this,arguments)}}();return s(),function(){S&&S.close()}},[]),(0,u.useEffect)(function(){Ge(),E.current=f},[f]);var Ve=function s(){var r=new WebSocket("".concat(Pe).concat(Oe,"?auth_token=").concat(localStorage.getItem("auth_token")));r.onopen=function(){$(!1),w.ZP.success("WebSocket \u5DF2\u8FDE\u63A5\uFF01")},r.onmessage=function(a){Je(a.data)},r.onclose=function(){window.location.pathname=="/chat"&&($(!0),setTimeout(s,5e3))},r.onerror=function(a){w.ZP.error("WebSocket \u8FDE\u63A5\u9519\u8BEF")},L(r)},rt=function(){var s=O()(C()().mark(function r(a){var l,g,B,le;return C()().wrap(function(p){for(;;)switch(p.prev=p.next){case 0:if(l=a.target.files,!(!l||l.length===0)){p.next=3;break}return p.abrupt("return");case 3:g=he()(l),p.prev=4,le=C()().mark(function Qe(){var U,D;return C()().wrap(function(V){for(;;)switch(V.prev=V.next){case 0:U=B.value,D=new FileReader,D.onload=function(){var J=O()(C()().mark(function ue(Xe){var Y,de,ce,fe,ve;return C()().wrap(function(G){for(;;)switch(G.prev=G.next){case 0:console.log("\u6587\u4EF6\u8BFB\u53D6\u5B8C\u6210 (handleFileUpload)"),de=(Y=Xe.target)===null||Y===void 0?void 0:Y.result,ce=U.type,fe=U.type.split("/")[0],S&&S.readyState===WebSocket.OPEN?(ve={type:fe,data:{file:de,mime:ce}},S.send(JSON.stringify([ve])),ie("[".concat(U.name,"]"),Date.now())):w.ZP.error("WebSocket \u8FDE\u63A5\u672A\u5C31\u7EEA");case 5:case"end":return G.stop()}},ue)}));return function(ue){return J.apply(this,arguments)}}(),D.onerror=function(J){console.error("\u6587\u4EF6\u8BFB\u53D6\u9519\u8BEF (handleFileUpload):",J),w.ZP.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},console.log("\u5F00\u59CB\u8BFB\u53D6\u6587\u4EF6:",U.name),D.readAsDataURL(U);case 6:case"end":return V.stop()}},Qe)}),g.s();case 7:if((B=g.n()).done){p.next=11;break}return p.delegateYield(le(),"t0",9);case 9:p.next=7;break;case 11:p.next=16;break;case 13:p.prev=13,p.t1=p.catch(4),g.e(p.t1);case 16:return p.prev=16,g.f(),p.finish(16);case 19:case"end":return p.stop()}},r,null,[[4,13,16,19]])}));return function(a){return s.apply(this,arguments)}}(),Je=function(r){try{var a=JSON.parse(r);if(!a.message){console.warn("\u6536\u5230\u65E0\u6548\u6D88\u606F:",a);return}var l;try{l=Ye(a.message.params.message[0].data.id)}catch(g){l=null}console.log(a.message),y(function(g){return[].concat(Q()(g),[{role:"start",replyContent:l,message_id:a.message_id,message:a.message}])})}catch(g){console.warn(g)}},Ye=function(r){var a=E.current.find(function(B){return B.message_id==r}),l=a==null?void 0:a.message.params.message.at(-1);if(l.type=="text")return l.data.text;if(l.type){var g={image:"[\u56FE\u7247]",node:"[\u8F6C\u53D1\u6D88\u606F]",music:"[\u97F3\u4E50]",audio:"[\u8BED\u97F3]",video:"[\u89C6\u9891]",file:"[\u6587\u4EF6]"};return"[".concat(g[l.type],"]")}return"\u539F\u6D88\u606F\u4E0D\u53EF\u7528"},ie=function(r,a){y(function(l){return[].concat(Q()(l),[{role:"end",message_id:a,message:{action:"send_group_msg",params:{message:[{type:"text",data:{text:r}}]}}}])})},Ge=function(){z.current&&(z.current.scrollTop=z.current.scrollHeight)},Ke=function(r){if(r.trim())if(S&&S.readyState===WebSocket.OPEN){var a,l=Date.now();ie(r,l),(a=v.current)===null||a===void 0||a.scrollTo({key:f.length-1,block:"nearest"}),S.send(JSON.stringify({type:"text",id:l,isat:M,data:{text:r}})),N(""),setTimeout(function(){},10)}else w.ZP.error("WebSocket \u672A\u8FDE\u63A5")},oe={container:{top:0,display:"flex",justifyContent:"center",alignItems:"center",overflow:"hidden"},chatCard:{width:"100%",height:"calc(100vh-100px)",display:"flex",flexDirection:"column"},chatContainer:{position:"relative",display:"flex",flexDirection:"column",borderRadius:"12px",height:"auto",marginBottom:"115px",overflowY:"auto"},message:{borderRadius:"1px",wordWrap:"break-word",margin:"10px 0",position:"relative"},userMessage:{marginLeft:"20%",background:"#1890ff",color:"white",borderBottomRightRadius:"4px"},serverMessage:{marginRight:"20%",background:"#f0f0f0",color:"#333",borderBottomLeftRadius:"4px"},bottomTools:{position:"absolute",left:"0",bottom:"0px",backgroundColor:Z?"#2e2e2e":"#fff",maxHeight:"50vh",overflowY:"auto"},uploadButton:{flexShrink:0},sendButton:{flexShrink:0}};return(0,t.jsxs)(H.Z,{spinning:!1,tip:"WebSocket\u8FDE\u63A5\u4E2D...",size:"large",children:[(0,t.jsx)(Se.Z,{style:{height:"calc(100vh - 100px)"},children:(0,t.jsxs)("div",{ref:ne,style:{width:"100%",height:"calc(100vh - 100px)",display:"flex",flexDirection:"column"},children:[(0,t.jsx)("div",{style:oe.chatContainer,ref:z,children:(0,t.jsx)(be.Z.List,{ref:v,items:f.map(function(s,r){return{key:r,placement:s.role,shape:"corner",content:(0,t.jsx)(Ue,{role:s.role,replyContent:s.replyContent,message:s.message,message_id:s.message_id})}})})}),(0,t.jsx)(Re.Z,{placeholder:"\u8BF7\u8F93\u5165...",style:oe.bottomTools,value:Ne,autoSize:{maxRows:8},onChange:function(r){N(r)},onSubmit:function(r){N(""),Ke(r)},footer:function(){return(0,t.jsx)(X.Z,{justify:"space-between",align:"center",children:(0,t.jsxs)(X.Z,{gap:"small",align:"center",children:["@\u673A\u5668\u4EBA",(0,t.jsx)(je.Z,{size:"small",checked:M,onChange:function(a){i(a)}})]})})},prefix:(0,t.jsx)(t.Fragment,{children:(0,t.jsx)(Ze.Z,{beforeUpload:function(){return!1},onChange:function(r){if(!r.file.originFileObj){console.error("\u6587\u4EF6\u5BF9\u8C61\u4E0D\u5B58\u5728"),w.ZP.error("\u6587\u4EF6\u4E0A\u4F20\u5931\u8D25\uFF1A\u65E0\u6CD5\u83B7\u53D6\u6587\u4EF6");return}var a=r.file.originFileObj;console.log("\u6587\u4EF6\u4E0A\u4F20:",a.name,a.type)},getDropContainer:function(){return ne.current},maxCount:5,multiple:!0,showUploadList:!1,placeholder:{icon:(0,t.jsx)(q.Z,{}),title:"\u677E\u5F00\u4E0A\u4F20",description:"\u5F53\u524D\u4EC5\u652F\u6301\u56FE\u7247"},children:(0,t.jsx)(Ce.ZP,{type:"text",icon:(0,t.jsx)(q.Z,{})})})})})]})}),(0,t.jsx)(Ae.q,{children:(0,t.jsx)("meta",{name:"referrer",content:"no-referrer"})})]})},De=ze}}]);
