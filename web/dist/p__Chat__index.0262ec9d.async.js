"use strict";(self.webpackChunkant_design_pro=self.webpackChunkant_design_pro||[]).push([[570],{30778:function(_e,X,r){r.r(X),r.d(X,{default:function(){return He}});var ge=r(19632),q=r.n(ge),pe=r(64599),me=r.n(pe),he=r(15009),S=r.n(he),Se=r(99289),$=r.n(Se),xe=r(5574),m=r.n(xe),l=r(67294),w=r(2453),_=r(74330),ye=r(4393),ee=r(86250),je=r(72269),Ce=r(83622),te=r(16596),be=r(76654),Re=r(45311),Te=r(73869),re=r(76772),N=r(71471),Fe=r(95715),Le=r(9669),ke=r.n(Le),Ze=r(10048),n=r(85893),Me=(0,Ze.Z)({html:!0,breaks:!0}),ae="",we=function(e){var p=N.Z.Text,h=N.Z.Title,i=(0,l.useState)({name:"\u52A0\u8F7D\u4E2D...",artists:"",picUrl:""}),x=m()(i,2),T=x[0],d=x[1],v=(0,l.useState)(!0),u=m()(v,2),y=u[0],B=u[1],D=(0,l.useState)(!1),M=m()(D,2),j=M[0],F=M[1];return(0,l.useEffect)(function(){var E=function(){var I=$()(S()().mark(function L(){var k,b,A,Z,U,O;return S()().wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(c.prev=0,b=(k=e.split("id=")[1])===null||k===void 0?void 0:k.split(".")[0],b){c.next=5;break}return F(!0),c.abrupt("return");case 5:return c.next=7,ke().get("https://music.163.com/api/song/detail?ids=[".concat(b,"]"));case 7:A=c.sent,Z=A.data,Z.code===200&&Z.songs&&Z.songs.length>0?(U=Z.songs[0],O=U.artists.map(function(z){return z.name}).join(", "),d({name:U.name,artists:O,picUrl:U.album.picUrl})):F(!0),c.next=16;break;case 12:c.prev=12,c.t0=c.catch(0),console.error("\u83B7\u53D6\u97F3\u4E50\u4FE1\u606F\u5931\u8D25:",c.t0),F(!0);case 16:return c.prev=16,B(!1),c.finish(16);case 19:case"end":return c.stop()}},L,null,[[0,12,16,19]])}));return function(){return I.apply(this,arguments)}}();E()},[e]),"WebUI\u70B9\u6B4C\u529F\u80FD\u5F00\u53D1\u4E2D\uFF0C\u656C\u8BF7\u671F\u5F85"},et=function(e){var p=Typography.Text,h=Typography.Title;if(!e)return _jsx("div",{children:"\u8F6C\u53D1\u6D88\u606F\u6570\u636E\u65E0\u6548"});var i=[],x="\u8F6C\u53D1\u6D88\u606F";return e.message&&e.message.params&&e.message.params.messages?(i=e.message.params.messages,i.length>0&&i[0].data&&i[0].data.nickname&&(x=i[0].data.nickname)):e.data&&e.data.content?(i=[{data:{content:e.data.content}}],e.data.nickname&&(x=e.data.nickname)):Array.isArray(e)&&(i=e),i.length===0?_jsx("div",{children:"\u8F6C\u53D1\u6D88\u606F\u6570\u636E\u65E0\u6548"}):_jsx(Card,{title:x,style:{marginTop:10,maxWidth:"100%",backgroundColor:"#f9f9f9"},size:"small",bordered:!0,children:_jsx(List,{itemLayout:"vertical",dataSource:i,renderItem:function(d){if(d.type==="node"&&d.data){var v=d.data.content||[];return _jsxs(List.Item,{children:[d.data.nickname&&_jsx("div",{style:{fontWeight:"bold",marginBottom:"4px"},children:d.data.nickname}),v.map(function(u,y){return u.type==="text"&&u.data&&u.data.text?_jsx("div",{style:{whiteSpace:"pre-wrap",fontSize:"14px"},children:u.data.text},y):null})]})}else if(d.type==="text"&&d.data&&d.data.text)return _jsx(List.Item,{children:_jsx("div",{style:{whiteSpace:"pre-wrap",fontSize:"14px"},children:d.data.text})});return null},split:!0})})},Ie=function(e){return(0,n.jsx)("video",{src:e,controls:!0,style:{maxWidth:"300px"}})},Ue=function(e){var p=(0,l.useState)(!0),h=m()(p,2),i=h[0],x=h[1],T=(0,l.useState)(!1),d=m()(T,2),v=d[0],u=d[1];return(0,n.jsx)(_.Z,{spinning:i,children:(0,n.jsx)(Fe.Z,{src:e,onLoad:function(){return x(!1)},style:{maxWidth:"150px",cursor:"pointer"}})})},tt=function(e){return _jsx("audio",{src:e,controls:!0,style:{width:"200px"}})},We=function(e){return e?(0,n.jsx)("div",{style:{padding:"5px",backgroundColor:"transparent",borderRadius:"4px",marginBottom:"8px",fontSize:"12px"},children:(0,n.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"8px"},children:e.length>50?"".concat(e.substring(0,50),"..."):e})}):null},Be=function(e,p){return(0,n.jsxs)("a",{href:e,target:"_blank",children:["\u70B9\u51FB\u4E0B\u8F7D\uFF1A",p]})},Ee=function(e){return(0,n.jsx)(N.Z,{children:(0,n.jsx)("div",{dangerouslySetInnerHTML:{__html:Me.render(e)}})})},Ae=function(e){var p,h,i,x=e.role,T=e.replyContent,d=e.message_id,v=e.message;console.log(T);var u=(0,re.useModel)("@@initialState"),y=u.initialState,B=u.setInitialState,D=y==null||(p=y.settings)===null||p===void 0?void 0:p.isDark,M=v.action,j=(h=v.params)===null||h===void 0?void 0:h.messages,F=(i=v.params)===null||i===void 0?void 0:i.message;switch(M){case"send_group_msg":if(F){var E=F.map(function(L,k){if(L.type=="text")return Ee(L.data.text);var b="".concat(ae,"/api/chat/file?path=").concat(L.data.file);switch(L.type){case"music":return we(b);case"image":return Ue(b);case"video":return Ie(b);case"reply":return We(T);default:return"[\u6682\u4E0D\u652F\u6301\u7684\u6D88\u606F\u7C7B\u578B]"}});return(0,n.jsx)("div",{children:E})}case"upload_group_file":var I="".concat(ae,"/api/chat/file?path=").concat(v.params.file);return Be(I,v.params.name)}return null},$e=Ae,De=r(64593),Oe="/api/ws",ze="",Pe=function(){var e,p=l.useRef(null),h=(0,re.useModel)("@@initialState"),i=h.initialState,x=h.setInitialState,T=i==null||(e=i.settings)===null||e===void 0?void 0:e.isDark,d=(0,l.useState)([]),v=m()(d,2),u=v[0],y=v[1],B=(0,l.useRef)([]),D=(0,l.useState)(null),M=m()(D,2),j=M[0],F=M[1],E=l.useState(!1),I=m()(E,2),L=I[0],k=I[1],b=l.useState(!0),A=m()(b,2),Z=A[0],U=A[1],O=l.useState(!0),V=m()(O,2),c=V[0],z=V[1],P=(0,l.useRef)(null),ne=l.useRef(null),Ne=(0,l.useState)(""),se=m()(Ne,2),Ve=se[0],J=se[1],rt=function(){console.log("Current messages:",u),u.forEach(function(t,a){console.log("Message ".concat(a,":"),t)})};(0,l.useEffect)(function(){var s=function(){var t=$()(S()().mark(function a(){return S()().wrap(function(g){for(;;)switch(g.prev=g.next){case 0:z(!0);try{}catch(R){console.error("\u52A0\u8F7D\u5386\u53F2\u6D88\u606F\u5931\u8D25:",R)}finally{z(!1),k(!0),Je()}case 2:case"end":return g.stop()}},a)}));return function(){return t.apply(this,arguments)}}();return s(),function(){j&&j.close()}},[]),(0,l.useEffect)(function(){Ke(),B.current=u},[u]);var Je=function s(){var t=new WebSocket("".concat(ze).concat(Oe,"?auth_token=").concat(localStorage.getItem("auth_token")));t.onopen=function(){k(!1),w.ZP.success("WebSocket \u5DF2\u8FDE\u63A5\uFF01")},t.onmessage=function(a){Ye(a.data)},t.onclose=function(){window.location.pathname=="/chat"&&(k(!0),setTimeout(s,5e3))},t.onerror=function(a){w.ZP.error("WebSocket \u8FDE\u63A5\u9519\u8BEF")},F(t)},at=function(){var s=$()(S()().mark(function t(a){var o,g,R,le;return S()().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(o=a.target.files,!(!o||o.length===0)){f.next=3;break}return f.abrupt("return");case 3:g=me()(o),f.prev=4,le=S()().mark(function Xe(){var W,H;return S()().wrap(function(Y){for(;;)switch(Y.prev=Y.next){case 0:W=R.value,H=new FileReader,H.onload=function(){var G=$()(S()().mark(function ue(qe){var K,de,ce,fe,ve;return S()().wrap(function(Q){for(;;)switch(Q.prev=Q.next){case 0:console.log("\u6587\u4EF6\u8BFB\u53D6\u5B8C\u6210 (handleFileUpload)"),de=(K=qe.target)===null||K===void 0?void 0:K.result,ce=W.type,fe=W.type.split("/")[0],j&&j.readyState===WebSocket.OPEN?(ve={type:fe,data:{file:de,mime:ce}},j.send(JSON.stringify([ve])),ie("[".concat(W.name,"]"),Date.now())):w.ZP.error("WebSocket \u8FDE\u63A5\u672A\u5C31\u7EEA");case 5:case"end":return Q.stop()}},ue)}));return function(ue){return G.apply(this,arguments)}}(),H.onerror=function(G){console.error("\u6587\u4EF6\u8BFB\u53D6\u9519\u8BEF (handleFileUpload):",G),w.ZP.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},console.log("\u5F00\u59CB\u8BFB\u53D6\u6587\u4EF6:",W.name),H.readAsDataURL(W);case 6:case"end":return Y.stop()}},Xe)}),g.s();case 7:if((R=g.n()).done){f.next=11;break}return f.delegateYield(le(),"t0",9);case 9:f.next=7;break;case 11:f.next=16;break;case 13:f.prev=13,f.t1=f.catch(4),g.e(f.t1);case 16:return f.prev=16,g.f(),f.finish(16);case 19:case"end":return f.stop()}},t,null,[[4,13,16,19]])}));return function(a){return s.apply(this,arguments)}}(),Ye=function(t){try{var a,o=JSON.parse(t);if(!((a=o.message)!==null&&a!==void 0&&a.params)){console.warn("\u6536\u5230\u65E0\u6548\u6D88\u606F:",o);return}var g=Ge(o.message.params.message[0].data.id);y(function(R){return[].concat(q()(R),[{role:"start",replyContent:g,message_id:o.message_id,message:o.message}])})}catch(R){}},Ge=function(t){var a=B.current.find(function(R){return R.message_id==t}),o=a==null?void 0:a.message.params.message.at(-1);if(o.type=="text")return o.data.text;if(o.type){var g={image:"[\u56FE\u7247]",node:"[\u8F6C\u53D1\u6D88\u606F]",music:"[\u97F3\u4E50]",audio:"[\u8BED\u97F3]",video:"[\u89C6\u9891]",file:"[\u6587\u4EF6]"};return"[".concat(g[o.type],"]")}return"\u539F\u6D88\u606F\u4E0D\u53EF\u7528"},ie=function(t,a){y(function(o){return[].concat(q()(o),[{role:"end",message_id:a,message:{action:"send_group_msg",params:{message:[{type:"text",data:{text:t}}]}}}])})},Ke=function(){P.current&&(P.current.scrollTop=P.current.scrollHeight)},Qe=function(t){if(t.trim())if(j&&j.readyState===WebSocket.OPEN){var a,o=Date.now();ie(t,o),(a=p.current)===null||a===void 0||a.scrollTo({key:u.length-1,block:"nearest"}),j.send(JSON.stringify({type:"text",id:o,isat:Z,data:{text:t}})),J(""),setTimeout(function(){},10)}else w.ZP.error("WebSocket \u672A\u8FDE\u63A5")},oe={container:{top:0,display:"flex",justifyContent:"center",alignItems:"center",overflow:"hidden"},chatCard:{width:"100%",height:"calc(100vh-100px)",display:"flex",flexDirection:"column"},chatContainer:{position:"relative",display:"flex",flexDirection:"column",borderRadius:"12px",height:"auto",marginBottom:"115px",overflowY:"auto"},message:{borderRadius:"1px",wordWrap:"break-word",margin:"10px 0",position:"relative"},userMessage:{marginLeft:"20%",background:"#1890ff",color:"white",borderBottomRightRadius:"4px"},serverMessage:{marginRight:"20%",background:"#f0f0f0",color:"#333",borderBottomLeftRadius:"4px"},bottomTools:{position:"absolute",left:"0",bottom:"0px",backgroundColor:T?"#2e2e2e":"#fff",maxHeight:"50vh",overflowY:"auto"},uploadButton:{flexShrink:0},sendButton:{flexShrink:0}};return(0,n.jsxs)(_.Z,{spinning:!1,tip:"WebSocket\u8FDE\u63A5\u4E2D...",size:"large",children:[(0,n.jsx)(ye.Z,{style:{height:"calc(100vh - 100px)"},children:(0,n.jsxs)("div",{ref:ne,style:{width:"100%",height:"calc(100vh - 100px)",display:"flex",flexDirection:"column"},children:[(0,n.jsx)("div",{style:oe.chatContainer,ref:P,children:(0,n.jsx)(be.Z.List,{ref:p,items:u.map(function(s,t){return{key:t,placement:s.role,shape:"corner",content:(0,n.jsx)($e,{role:s.role,replyContent:s.replyContent,message:s.message,message_id:s.message_id})}})})}),(0,n.jsx)(Re.Z,{placeholder:"\u8BF7\u8F93\u5165...",style:oe.bottomTools,value:Ve,autoSize:{maxRows:8},onChange:function(t){J(t)},onSubmit:function(t){J(""),Qe(t)},footer:function(){return(0,n.jsx)(ee.Z,{justify:"space-between",align:"center",children:(0,n.jsxs)(ee.Z,{gap:"small",align:"center",children:["@\u673A\u5668\u4EBA",(0,n.jsx)(je.Z,{size:"small",checked:Z,onChange:function(a){U(a)}})]})})},prefix:(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(Te.Z,{beforeUpload:function(){return!1},onChange:function(t){if(!t.file.originFileObj){console.error("\u6587\u4EF6\u5BF9\u8C61\u4E0D\u5B58\u5728"),w.ZP.error("\u6587\u4EF6\u4E0A\u4F20\u5931\u8D25\uFF1A\u65E0\u6CD5\u83B7\u53D6\u6587\u4EF6");return}var a=t.file.originFileObj;console.log("\u6587\u4EF6\u4E0A\u4F20:",a.name,a.type)},getDropContainer:function(){return ne.current},maxCount:5,multiple:!0,showUploadList:!1,placeholder:{icon:(0,n.jsx)(te.Z,{}),title:"\u677E\u5F00\u4E0A\u4F20",description:"\u5F53\u524D\u4EC5\u652F\u6301\u56FE\u7247"},children:(0,n.jsx)(Ce.ZP,{type:"text",icon:(0,n.jsx)(te.Z,{})})})})})]})}),(0,n.jsx)(De.q,{children:(0,n.jsx)("meta",{name:"referrer",content:"no-referrer"})})]})},He=Pe}}]);
