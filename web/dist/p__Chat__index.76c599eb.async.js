"use strict";(self.webpackChunkant_design_pro=self.webpackChunkant_design_pro||[]).push([[570],{30778:function(er,G,t){t.r(G),t.d(G,{default:function(){return He}});var pe=t(19632),K=t.n(pe),ge=t(64599),he=t.n(ge),me=t(15009),x=t.n(me),xe=t(99289),I=t.n(xe),ye=t(5574),y=t.n(ye),d=t(67294),R=t(2453),O=t(74330),Se=t(4393),Q=t(86250),je=t(72269),Ce=t(83622),X=t(16596),q=t(76654),Re=t(45311),be=t(73869),Fe=t(76772),Z=t(71471),_=t(95715),Ze=t(2618),e=t(85893),we=t(95150),Le=we({html:!0,breaks:!0}),ee="",Me=function(r,i,v,o,b){var C=(0,d.useState)(null),p=y()(C,2),g=p[0],h=p[1],m=(0,d.useState)(!0),F=y()(m,2),B=F[0],w=F[1],j=(0,d.useState)(null),$=y()(j,2),U=$[0],k=$[1];return(0,d.useEffect)(function(){var P=function(){var D=I()(x()().mark(function W(){var L;return x()().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:if(u.prev=0,r!="custom"){u.next=5;break}h({desc:"",musicUrl:v,title:b,preview:o}),u.next=9;break;case 5:return u.next=7,(0,Ze.Hv)({type:r,id:i});case 7:L=u.sent,L?h(L):k("\u672A\u83B7\u53D6\u5230\u97F3\u4E50\u4FE1\u606F");case 9:u.next=16;break;case 11:u.prev=11,u.t0=u.catch(0),console.error("\u83B7\u53D6\u97F3\u4E50\u4FE1\u606F\u5931\u8D25:",u.t0),k(u.t0.message||"\u83B7\u53D6\u97F3\u4E50\u4FE1\u606F\u5931\u8D25"),R.ZP.error("\u83B7\u53D6\u97F3\u4E50\u4FE1\u606F\u5931\u8D25");case 16:return u.prev=16,w(!1),u.finish(16);case 19:case"end":return u.stop()}},W,null,[[0,11,16,19]])}));return function(){return D.apply(this,arguments)}}();P()},[r,i]),B?(0,e.jsx)(O.Z,{}):U?(0,e.jsx)(Z.Z,{children:U}):g?(0,e.jsx)(Z.Z,{style:{width:400,maxWidth:"100%"},children:(0,e.jsxs)("div",{style:{display:"flex",alignItems:"center"},children:[(0,e.jsx)(_.Z,{src:g.preview||"https://picsum.photos/128/128",height:110,style:{borderRadius:"6px"}}),(0,e.jsxs)("div",{style:{marginLeft:12,flex:1},children:[(0,e.jsx)(Z.Z.Title,{level:5,style:{margin:0},children:g.title||"\u672A\u77E5\u6807\u9898"}),(0,e.jsx)(Z.Z.Text,{type:"secondary",children:g.desc||"\u65E0\u63CF\u8FF0"}),(0,e.jsx)("audio",{src:g.musicUrl||"",controls:!0,style:{width:"100%",marginTop:4}})]})]})}):(0,e.jsx)(Z.Z,{children:"\u6CA1\u6709\u627E\u5230\u97F3\u4E50\u4FE1\u606F"})},Te=function(r){return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("div",{style:{padding:"5px",backgroundColor:"transparent",borderRadius:"4px",marginBottom:"8px",fontSize:"16px"},children:(0,e.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"8px"},children:"\u8F6C\u53D1\u4FE1\u606F"})}),(0,e.jsx)(q.Z.List,{items:r.map(function(i,v){return console.log(i.data.content),{key:v,placement:"start",shape:"corner",content:re(i.data.content,"start",null)}})})]})},Be=function(r){return(0,e.jsx)("video",{src:r,controls:!0,style:{maxWidth:"300px"}})},ke=function(r){var i=(0,d.useState)(!0),v=y()(i,2),o=v[0],b=v[1];return(0,e.jsx)("div",{children:(0,e.jsx)(O.Z,{spinning:o,children:(0,e.jsx)("div",{style:{position:"relative"},children:(0,e.jsx)(_.Z,{src:r,onLoad:function(){return b(!1)},style:{maxWidth:"300px",cursor:"pointer"}})})})})},De=function(r){return(0,e.jsx)("audio",{src:r,controls:!0,style:{width:"300px"}})},Ie=function(r){return r?(0,e.jsx)("div",{style:{padding:"5px",backgroundColor:"transparent",borderRadius:"4px",marginBottom:"8px",fontSize:"12px"},children:(0,e.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"8px"},children:r.length>50?"".concat(r.substring(0,50),"..."):r})}):null},$e=function(r,i){return(0,e.jsxs)("a",{href:r,target:"_blank",children:["\u70B9\u51FB\u4E0B\u8F7D\uFF1A",i]})},Ue=function(r,i){return(0,e.jsx)(Z.Z,{children:i=="start"?(0,e.jsx)("div",{dangerouslySetInnerHTML:{__html:Le.render(r)}}):(0,e.jsx)("div",{children:r})})},re=function(r,i,v){return r.map(function(o,b){var C,p,g,h;if(o.type=="text")return Ue(o.data.text,i);var m="".concat(ee,"/api/chat/file?path=").concat(o.data.file);switch(o.type){case"music":return Me(o.data.type,(C=o.data)===null||C===void 0?void 0:C.id,(p=o.data)===null||p===void 0?void 0:p.audio,(g=o.data)===null||g===void 0?void 0:g.image,(h=o.data)===null||h===void 0?void 0:h.title);case"image":return ke(m);case"video":return Be(m);case"record":return De(m);case"reply":return Ie(v);case"at":return"@\u4F60";default:return"[\u6682\u4E0D\u652F\u6301\u7684\u6D88\u606F\u7C7B\u578B:".concat(o.type,"]")}})},We=function(r){var i,v,o=r.role,b=r.replyContent,C=r.message_id,p=r.message,g=p.action,h=(i=p.params)===null||i===void 0?void 0:i.messages,m=(v=p.params)===null||v===void 0?void 0:v.message;switch(g){case"send_group_forward_msg":if(h){var F=Te(h);return(0,e.jsx)("div",{children:F})}case"send_group_msg":if(m){var B=re(m,o,b||null);return(0,e.jsx)("div",{children:B})}case"upload_group_file":var w="".concat(ee,"/api/chat/file?path=").concat(p.params.file);return $e(w,p.params.name);case"delete_msg":return"[\u6D88\u606F\u64A4\u56DE\u4E8B\u4EF6]"}return null},Ee=We,Ae=t(64593),Oe="/api/ws",Pe="",ze=function(){var r,i=d.useRef(null),v=(0,Fe.useModel)("@@initialState"),o=v.initialState,b=v.setInitialState,C=o==null||(r=o.settings)===null||r===void 0?void 0:r.isDark,p=(0,d.useState)([]),g=y()(p,2),h=g[0],m=g[1],F=(0,d.useRef)([]),B=(0,d.useState)(null),w=y()(B,2),j=w[0],$=w[1],U=d.useState(!1),k=y()(U,2),P=k[0],D=k[1],W=d.useState(!0),L=y()(W,2),z=L[0],u=L[1],Ne=d.useState(!0),te=y()(Ne,2),rr=te[0],ae=te[1],E=(0,d.useRef)(null),ne=d.useRef(null),Ve=(0,d.useState)(""),se=y()(Ve,2),Je=se[0],H=se[1];(0,d.useEffect)(function(){var s=function(){var a=I()(x()().mark(function n(){return x()().wrap(function(c){for(;;)switch(c.prev=c.next){case 0:ae(!0);try{}catch(M){console.error("\u52A0\u8F7D\u5386\u53F2\u6D88\u606F\u5931\u8D25:",M)}finally{ae(!1),D(!0),Ye()}case 2:case"end":return c.stop()}},n)}));return function(){return a.apply(this,arguments)}}();return s(),function(){j&&j.close()}},[]),(0,d.useEffect)(function(){Qe(),F.current=h},[h]);var Ye=function s(){var a=new WebSocket("".concat(Pe).concat(Oe,"?auth_token=").concat(localStorage.getItem("auth_token")));a.onopen=function(){D(!1),R.ZP.success("WebSocket \u5DF2\u8FDE\u63A5\uFF01")},a.onmessage=function(n){Ge(n.data)},a.onclose=function(){window.location.pathname=="/chat"&&(D(!0),setTimeout(s,5e3))},a.onerror=function(n){R.ZP.error("WebSocket \u8FDE\u63A5\u9519\u8BEF")},$(a)},tr=function(){var s=I()(x()().mark(function a(n){var l,c,M,le;return x()().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(l=n.target.files,!(!l||l.length===0)){f.next=3;break}return f.abrupt("return");case 3:c=he()(l),f.prev=4,le=x()().mark(function qe(){var T,A;return x()().wrap(function(N){for(;;)switch(N.prev=N.next){case 0:T=M.value,A=new FileReader,A.onload=function(){var V=I()(x()().mark(function ue(_e){var J,de,ce,fe,ve;return x()().wrap(function(Y){for(;;)switch(Y.prev=Y.next){case 0:console.log("\u6587\u4EF6\u8BFB\u53D6\u5B8C\u6210 (handleFileUpload)"),de=(J=_e.target)===null||J===void 0?void 0:J.result,ce=T.type,fe=T.type.split("/")[0],j&&j.readyState===WebSocket.OPEN?(ve={type:fe,data:{file:de,mime:ce}},j.send(JSON.stringify([ve])),ie("[".concat(T.name,"]"),Date.now())):R.ZP.error("WebSocket \u8FDE\u63A5\u672A\u5C31\u7EEA");case 5:case"end":return Y.stop()}},ue)}));return function(ue){return V.apply(this,arguments)}}(),A.onerror=function(V){console.error("\u6587\u4EF6\u8BFB\u53D6\u9519\u8BEF (handleFileUpload):",V),R.ZP.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},console.log("\u5F00\u59CB\u8BFB\u53D6\u6587\u4EF6:",T.name),A.readAsDataURL(T);case 6:case"end":return N.stop()}},qe)}),c.s();case 7:if((M=c.n()).done){f.next=11;break}return f.delegateYield(le(),"t0",9);case 9:f.next=7;break;case 11:f.next=16;break;case 13:f.prev=13,f.t1=f.catch(4),c.e(f.t1);case 16:return f.prev=16,c.f(),f.finish(16);case 19:case"end":return f.stop()}},a,null,[[4,13,16,19]])}));return function(n){return s.apply(this,arguments)}}(),Ge=function(a){try{var n=JSON.parse(a);if(!n.message){console.warn("\u6536\u5230\u65E0\u6548\u6D88\u606F:",n);return}var l;try{l=Ke(n.message.params.message[0].data.id)}catch(c){l=null}m(function(c){return[].concat(K()(c),[{role:"start",replyContent:l,message_id:n.message_id,message:n.message}])})}catch(c){console.warn(c)}},Ke=function(a){var n=F.current.find(function(M){return M.message_id==a}),l=n==null?void 0:n.message.params.message.at(-1);if(l.type=="text")return l.data.text;if(l.type){var c={image:"[\u56FE\u7247]",node:"[\u8F6C\u53D1\u6D88\u606F]",music:"[\u97F3\u4E50]",audio:"[\u8BED\u97F3]",video:"[\u89C6\u9891]",file:"[\u6587\u4EF6]"};return"[".concat(c[l.type],"]")}return"\u539F\u6D88\u606F\u4E0D\u53EF\u7528"},ie=function(a,n){m(function(l){return[].concat(K()(l),[{role:"end",message_id:n,message:{action:"send_group_msg",params:{message:[{type:"text",data:{text:a}}]}}}])})},Qe=function(){E.current&&(E.current.scrollTop=E.current.scrollHeight)},Xe=function(a){if(a.trim())if(j&&j.readyState===WebSocket.OPEN){var n,l=Date.now();ie(a,l),(n=i.current)===null||n===void 0||n.scrollTo({key:h.length-1,block:"nearest"}),j.send(JSON.stringify({type:"text",id:l,isat:z,data:{text:a}})),H(""),setTimeout(function(){},10)}else R.ZP.error("WebSocket \u672A\u8FDE\u63A5")},oe={container:{top:0,display:"flex",justifyContent:"center",alignItems:"center",overflow:"hidden"},chatCard:{width:"100%",height:"calc(100vh-100px)",display:"flex",flexDirection:"column"},chatContainer:{position:"relative",display:"flex",flexDirection:"column",borderRadius:"12px",height:"auto",marginBottom:"115px",overflowY:"auto"},message:{borderRadius:"1px",wordWrap:"break-word",margin:"10px 0",position:"relative"},userMessage:{marginLeft:"20%",background:"#1890ff",color:"white",borderBottomRightRadius:"4px"},serverMessage:{marginRight:"20%",background:"#f0f0f0",color:"#333",borderBottomLeftRadius:"4px"},bottomTools:{position:"absolute",left:"0",bottom:"0px",backgroundColor:C?"#2e2e2e":"#fff",maxHeight:"50vh",overflowY:"auto"},uploadButton:{flexShrink:0},sendButton:{flexShrink:0}};return(0,e.jsxs)(O.Z,{spinning:P,tip:"WebSocket\u8FDE\u63A5\u4E2D...",size:"large",children:[(0,e.jsx)(Se.Z,{style:{height:"calc(100vh - 100px)"},children:(0,e.jsxs)("div",{ref:ne,style:{width:"100%",height:"calc(100vh - 100px)",display:"flex",flexDirection:"column"},children:[(0,e.jsx)("div",{style:oe.chatContainer,ref:E,children:(0,e.jsx)(q.Z.List,{ref:i,items:h.map(function(s,a){return{key:a,placement:s.role,shape:"corner",content:(0,e.jsx)(Ee,{role:s.role,replyContent:s.replyContent,message:s.message,message_id:s.message_id})}})})}),(0,e.jsx)(Re.Z,{placeholder:"\u8BF7\u8F93\u5165...",style:oe.bottomTools,value:Je,autoSize:{maxRows:8},onChange:function(a){H(a)},onSubmit:function(a){H(""),Xe(a)},footer:function(){return(0,e.jsx)(Q.Z,{justify:"space-between",align:"center",children:(0,e.jsxs)(Q.Z,{gap:"small",align:"center",children:["@\u673A\u5668\u4EBA",(0,e.jsx)(je.Z,{size:"small",checked:z,onChange:function(n){u(n)}})]})})},prefix:(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(be.Z,{beforeUpload:function(){return!1},onChange:function(a){if(!a.file.originFileObj){console.error("\u6587\u4EF6\u5BF9\u8C61\u4E0D\u5B58\u5728"),R.ZP.error("\u6587\u4EF6\u4E0A\u4F20\u5931\u8D25\uFF1A\u65E0\u6CD5\u83B7\u53D6\u6587\u4EF6");return}var n=a.file.originFileObj;console.log("\u6587\u4EF6\u4E0A\u4F20:",n.name,n.type)},getDropContainer:function(){return ne.current},maxCount:5,multiple:!0,showUploadList:!1,placeholder:{icon:(0,e.jsx)(X.Z,{}),title:"\u677E\u5F00\u4E0A\u4F20",description:"\u5F53\u524D\u4EC5\u652F\u6301\u56FE\u7247"},children:(0,e.jsx)(Ce.ZP,{type:"text",icon:(0,e.jsx)(X.Z,{})})})})})]})}),(0,e.jsx)(Ae.q,{children:(0,e.jsx)("meta",{name:"referrer",content:"no-referrer"})})]})},He=ze}}]);
