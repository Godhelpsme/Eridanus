"use strict";(self.webpackChunkant_design_pro=self.webpackChunkant_design_pro||[]).push([[570],{67179:function(Ge,L,t){t.r(L),t.d(L,{default:function(){return Ce}});var ae=t(97857),R=t.n(ae),re=t(19632),x=t.n(re),te=t(64599),ne=t.n(te),oe=t(15009),S=t.n(oe),ie=t(99289),P=t.n(ie),le=t(5574),b=t.n(le),f=t(67294),se=t(9361),g=t(2453),ue=t(42075),D=t(74330),de=t(4393),ce=t(83622),k=t(16596),fe=t(76654),ve=t(45311),pe=t(39559),M={container:"container___PlbYR",chatCard:"chatCard___Xx0Vw",chatContainer:"chatContainer___SP6io",message:"message___XLm3g",userMessage:"userMessage___Wp0tl",serverMessage:"serverMessage___GAfYU",bottomTools:"bottomTools___GZxgP",uploadButton:"uploadButton___h6D76",sendButton:"sendButton___gOHpp"},he=t(51285),Se=t.n(he),u=t(85893),ye="ws://v4.frp1.gcbe.eu.org:5008",ge="http://v4.frp1.gcbe.eu.org:5007",me=function(){var be=(0,f.useState)([]),V=b()(be,2),w=V[0],j=V[1],je=(0,f.useState)(null),G=b()(je,2),d=G[0],We=G[1],Fe=f.useState(!1),$=b()(Fe,2),Te=$[0],A=$[1],Z=(0,f.useRef)(null),J=f.useRef(null),Re=se.Z.useToken(),z=Re.token,xe=z.colorBgContainer,Je=z.borderRadiusLG,Me=(0,f.useState)(!1),H=b()(Me,2),Ze=H[0],Y=H[1],Be=(0,f.useState)(""),X=b()(Be,2),Oe=X[0],Pe=X[1],Ae=(0,f.useState)(""),I=b()(Ae,2),Ee=I[0],K=I[1];(0,f.useEffect)(function(){return A(!0),Ne(),function(){d&&d.close()}},[]),(0,f.useEffect)(function(){Ve()},[w]);var Ne=function o(){var a=new WebSocket(ye);a.onopen=function(){A(!1),c("WebSocket \u5DF2\u8FDE\u63A5\uFF01")},a.onmessage=function(e){De(e.data)},a.onclose=function(){window.location.pathname=="/chat"&&(A(!0),g.ZP.loading("WebSocket \u8FDE\u63A5\u5DF2\u65AD\u5F00\uFF0C\u6B63\u5728\u5C1D\u8BD5\u91CD\u65B0\u8FDE\u63A5..."),setTimeout(o,5e3))},a.onerror=function(e){c("WebSocket \u8FDE\u63A5\u9519\u8BEF")},We(a)},Ue=function(a,e,l){return(0,u.jsxs)("div",{children:[a?"".concat(a):"",l?(0,u.jsx)("div",{style:{padding:"10px",textAlign:"center"},children:(0,u.jsxs)(ue.Z,{children:[(0,u.jsx)(D.Z,{size:"small"}),(0,u.jsx)("span",{children:"\u5A92\u4F53\u52A0\u8F7D\u4E2D..."})]})}):e?(0,u.jsx)("div",{children:e.startsWith("data:image")?(0,u.jsx)("img",{src:e,style:{maxWidth:"200px",cursor:"pointer"},onClick:function(){Pe(e),Y(!0)}}):e.startsWith("data:video")?(0,u.jsx)("video",{src:e,controls:!0,style:{maxWidth:"200px"}}):e.startsWith("data:audio")?(0,u.jsx)("audio",{src:e,controls:!0,style:{width:"200px"}}):(0,u.jsx)("div",{children:"\u4E0D\u652F\u6301\u7684\u5A92\u4F53\u7C7B\u578B"})}):""]})},Le=function(){var o=P()(S()().mark(function a(e){var l,s;return S()().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,fetch("".concat(ge,"/api/file2base64"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e})});case 3:return l=n.sent,n.next=6,l.json();case 6:if(s=n.sent,!s.base64){n.next=11;break}return n.abrupt("return",s.base64);case 11:return console.error("Error:",s.error),n.abrupt("return",null);case 13:n.next=19;break;case 15:return n.prev=15,n.t0=n.catch(0),console.error("Request failed:",n.t0),n.abrupt("return",null);case 19:case"end":return n.stop()}},a,null,[[0,15]])}));return function(e){return o.apply(this,arguments)}}(),ze=function(){var o=P()(S()().mark(function a(e){var l,s,r,n;return S()().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(l=e.target.files,!(!l||l.length===0)){i.next=3;break}return i.abrupt("return");case 3:s=ne()(l),i.prev=4,n=S()().mark(function v(){var p,y;return S()().wrap(function(m){for(;;)switch(m.prev=m.next){case 0:p=r.value,y=new FileReader,y.onload=function(){var h=P()(S()().mark(function F(O){var C,T,q,_,ee;return S()().wrap(function(U){for(;;)switch(U.prev=U.next){case 0:console.log("\u6587\u4EF6\u8BFB\u53D6\u5B8C\u6210 (handleFileUpload)"),T=(C=O.target)===null||C===void 0?void 0:C.result,q=p.type,_=p.type.split("/")[0],d&&d.readyState===WebSocket.OPEN?(ee={type:_,data:{file:T,mime:q}},d.send(JSON.stringify([ee])),E("[".concat(p.name,"]"))):g.ZP.error("WebSocket \u8FDE\u63A5\u672A\u5C31\u7EEA");case 5:case"end":return U.stop()}},F)}));return function(F){return h.apply(this,arguments)}}(),y.onerror=function(h){console.error("\u6587\u4EF6\u8BFB\u53D6\u9519\u8BEF (handleFileUpload):",h),g.ZP.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},console.log("\u5F00\u59CB\u8BFB\u53D6\u6587\u4EF6:",p.name),y.readAsDataURL(p);case 6:case"end":return m.stop()}},v)}),s.s();case 7:if((r=s.n()).done){i.next=11;break}return i.delegateYield(n(),"t0",9);case 9:i.next=7;break;case 11:i.next=16;break;case 13:i.prev=13,i.t1=i.catch(4),s.e(i.t1);case 16:return i.prev=16,s.f(),i.finish(16);case 19:case"end":return i.stop()}},a,null,[[4,13,16,19]])}));return function(e){return o.apply(this,arguments)}}(),De=function(a){try{var e,l=JSON.parse(a);if(!((e=l.message)!==null&&e!==void 0&&e.params)){console.warn("\u6536\u5230\u65E0\u6548\u6D88\u606F:",l);return}var s=l.message.params.messages||l.message.params.message;if(!Array.isArray(s)){console.warn("\u6D88\u606F\u683C\u5F0F\u9519\u8BEF:",s);return}s.forEach(function(r){var n,W,i,v,p;if(r.type==="text"&&(n=r.data)!==null&&n!==void 0&&n.text)c(r.data.text);else if(r.type==="image"){var y,B,m,h=Date.now().toString();ke(h),(y=r.data)!==null&&y!==void 0&&y.file&&typeof r.data.file=="string"&&!r.data.file.startsWith("data:")?Le(r.data.file).then(function(T){T?N(h,T):Q(h)}):(B=r.data)!==null&&B!==void 0&&B.url?N(h,r.data.url):(m=r.data)!==null&&m!==void 0&&m.file&&typeof r.data.file=="string"&&r.data.file.startsWith("data:")?N(h,r.data.file):Q(h)}else if(r.type==="video"&&((W=r.data)!==null&&W!==void 0&&W.file||(i=r.data)!==null&&i!==void 0&&i.url)){var F=r.data.url||r.data.file;typeof F=="string"&&F.startsWith("data:"),c("[\u89C6\u9891] ".concat(r.data.name||""))}else if(r.type==="audio"&&((v=r.data)!==null&&v!==void 0&&v.file||(p=r.data)!==null&&p!==void 0&&p.url)){var O=r.data.url||r.data.file;typeof O=="string"&&O.startsWith("data:"),c("[\u97F3\u9891] ".concat(r.data.name||""))}else if(r.type==="file"){var C;c("[\u6587\u4EF6] ".concat(((C=r.data)===null||C===void 0?void 0:C.name)||""))}else c("\u672A\u77E5\u6D88\u606F\u7C7B\u578B: ".concat(r.type))})}catch(r){c("\u89E3\u6790\u670D\u52A1\u5668\u6D88\u606F\u5931\u8D25: "+r),c("[\u6D88\u606F\u683C\u5F0F\u65E0\u6548]")}},E=function(a){j(function(e){return[].concat(x()(e),[{role:"end",content:a}])})},c=function(a){j(function(e){return[].concat(x()(e),[{role:"start",content:a}])})},ke=function(a){j(function(e){return[].concat(x()(e),[{role:"start",loading:!0,id:a}])})},N=function(a,e){j(function(l){return l.map(function(s){return s.id===a?R()(R()({},s),{},{base64:e,loading:!1}):s})})},Q=function(a){j(function(e){return e.map(function(l){return l.id===a?R()(R()({},l),{},{content:"\u56FE\u7247\u52A0\u8F7D\u5931\u8D25",loading:!1}):l})})},He=function(a){j(function(e){return[].concat(x()(e),[{role:"start",base64:a}])})},Ve=function(){Z.current&&(Z.current.scrollTop=Z.current.scrollHeight)},we=function(a){a.trim()&&(d&&d.readyState===WebSocket.OPEN?(E(a),d.send(JSON.stringify([{type:"text",data:{text:a}}])),K(""),setTimeout(function(){},10)):g.ZP.error("WebSocket \u672A\u8FDE\u63A5"))};return(0,u.jsx)(D.Z,{spinning:Te,size:"large",children:(0,u.jsxs)(de.Z,{className:M.chatCard,ref:J,children:[(0,u.jsx)("div",{className:M.chatContainer,ref:Z,children:w.map(function(o,a){return(0,u.jsx)(fe.Z,{placement:o.role,shape:"corner",className:M.message,messageRender:function(){return Ue(o.content,o.base64,o.loading)}},a)})}),(0,u.jsx)(Se(),{visible:Ze,onClose:function(){return Y(!1)},images:[{src:Oe,alt:""}],zIndex:1e3,noNavbar:!0,scalable:!0,rotatable:!0}),(0,u.jsx)(ve.Z,{style:{backgroundColor:xe,marginRight:5},placeholder:"\u8BF7\u8F93\u5165...",className:M.bottomTools,value:Ee,autoSize:!0,onChange:function(a){K(a)},onSubmit:function(a){we(a)},prefix:(0,u.jsx)(u.Fragment,{children:(0,u.jsx)(pe.Z,{beforeUpload:function(){return!1},onChange:function(a){if(!a.file.originFileObj){console.error("\u6587\u4EF6\u5BF9\u8C61\u4E0D\u5B58\u5728"),g.ZP.error("\u6587\u4EF6\u4E0A\u4F20\u5931\u8D25\uFF1A\u65E0\u6CD5\u83B7\u53D6\u6587\u4EF6");return}var e=a.file.originFileObj;console.log("\u6587\u4EF6\u4E0A\u4F20:",e.name,e.type);var l=new FileReader;l.onload=function(s){var r;console.log("\u6587\u4EF6\u8BFB\u53D6\u5B8C\u6210");var n=(r=s.target)===null||r===void 0?void 0:r.result,W=e.type,i=e.type.split("/")[0];if(d&&d.readyState===WebSocket.OPEN){var v;i==="image"?v={type:i,data:{url:n,file:e.name}}:i==="video"||i==="audio"?v={type:i,data:{file:n}}:v={type:"file",data:{name:e.name,content:n}},d.send(JSON.stringify([v])),E("[".concat(e.name,"]"))}else g.ZP.error("WebSocket \u8FDE\u63A5\u672A\u5C31\u7EEA")},l.onerror=function(s){console.error("\u6587\u4EF6\u8BFB\u53D6\u9519\u8BEF:",s),g.ZP.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},l.readAsDataURL(e)},getDropContainer:function(){return J.current},maxCount:5,multiple:!0,showUploadList:!1,placeholder:{icon:(0,u.jsx)(k.Z,{}),title:"\u677E\u5F00\u4E0A\u4F20",description:"\u652F\u6301\u6587\u4EF6\uFF1A\u56FE\u7247\u3001\u89C6\u9891\u3001\u97F3\u9891\u7B49"},children:(0,u.jsx)(ce.ZP,{type:"text",icon:(0,u.jsx)(k.Z,{})})})})})]})})},Ce=me}}]);
