"use strict";(self.webpackChunkant_design_pro=self.webpackChunkant_design_pro||[]).push([[570],{10163:function(ze,X,i){i.r(X),i.d(X,{default:function(){return xe}});var ae=i(97857),F=i.n(ae),oe=i(19632),x=i.n(oe),ie=i(64599),Y=i.n(ie),le=i(15009),C=i.n(le),ue=i(99289),H=i.n(ue),se=i(5574),w=i.n(se),g=i(67294),R=i(2453),K=i(74330),de=i(4393),ce=i(83622),I=i(16596),fe=i(76654),ve=i(45311),pe=i(39559),z={container:"container___h48jj",chatCard:"chatCard___Gvfnw",chatContainer:"chatContainer___JSUGd",message:"message___LqdX4",userMessage:"userMessage____4aef",serverMessage:"serverMessage___qvzZu",bottomTools:"bottomTools___ITAsD",uploadButton:"uploadButton___EvFcs",sendButton:"sendButton___zQ6N0"},he=i(2618),Se=i(42075),ye=i(91439),u=i(85893),Ce=function(Z){var L=Z.content,f=Z.base64,d=Z.loading,b=Z.replyTo;return(0,u.jsxs)("div",{children:[b!=null&&b.content?(0,u.jsx)("div",{style:{padding:"5px",backgroundColor:"#f0f0f0",borderRadius:"4px",marginBottom:"8px",fontSize:"12px",color:"#666"},children:(0,u.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"8px"},children:b.content.length>50?"".concat(b.content.substring(0,50),"..."):b.content})}):null,L?"".concat(L):"",d?(0,u.jsx)("div",{style:{padding:"10px",textAlign:"center"},children:(0,u.jsxs)(Se.Z,{children:[(0,u.jsx)(K.Z,{size:"small"}),(0,u.jsx)("span",{children:"\u52A0\u8F7D\u4E2D..."})]})}):f?(0,u.jsx)("div",{children:f.startsWith("data:image")?(0,u.jsx)(ye.Z,{src:f,style:{maxWidth:"200px",cursor:"pointer"}}):f.startsWith("data:video")?(0,u.jsx)("video",{src:f,controls:!0,style:{maxWidth:"200px"}}):f.startsWith("data:audio")?(0,u.jsx)("audio",{src:f,controls:!0,style:{width:"200px"}}):(0,u.jsx)("div",{children:"\u4E0D\u652F\u6301\u7684\u5A92\u4F53\u7C7B\u578B"})}):""]})},ge=Ce,be="/api/ws",Je="",je=function(){var Z=(0,g.useState)([]),L=w()(Z,2),f=L[0],d=L[1],b=(0,g.useState)(null),$=w()(b,2),v=$[0],Te=$[1],We=g.useState(!1),q=w()(We,2),Fe=q[0],V=q[1],J=(0,g.useRef)(null),_=g.useRef(null),Re=(0,g.useState)(""),ee=w()(Re,2),Ze=ee[0],ne=ee[1];(0,g.useEffect)(function(){return V(!0),me(),function(){v&&v.close()}},[]),(0,g.useEffect)(function(){te()},[f]);var me=function a(){var e=new WebSocket("".concat(be,"?auth_token=").concat(localStorage.getItem("auth_token")));e.onopen=function(){V(!1),N("WebSocket \u5DF2\u8FDE\u63A5\uFF01")},e.onmessage=function(n){Ue(n.data)},e.onclose=function(){window.location.pathname=="/chat"&&(V(!0),setTimeout(a,5e3))},e.onerror=function(n){N("WebSocket \u8FDE\u63A5\u9519\u8BEF")},Te(e)},Be=function(){var a=H()(C()().mark(function e(n){return C()().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,he.vT)(JSON.stringify({path:n})).then(function(s){return s.base64?s.base64:null}).catch(function(){return null});case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}},e)}));return function(n){return a.apply(this,arguments)}}(),Ge=function(){var a=H()(C()().mark(function e(n){var r,t,s,c;return C()().wrap(function(l){for(;;)switch(l.prev=l.next){case 0:if(r=n.target.files,!(!r||r.length===0)){l.next=3;break}return l.abrupt("return");case 3:t=Y()(r),l.prev=4,c=C()().mark(function p(){var S,M;return C()().wrap(function(j){for(;;)switch(j.prev=j.next){case 0:S=s.value,M=new FileReader,M.onload=function(){var m=H()(C()().mark(function B(O){var T,U,A,o,E;return C()().wrap(function(W){for(;;)switch(W.prev=W.next){case 0:console.log("\u6587\u4EF6\u8BFB\u53D6\u5B8C\u6210 (handleFileUpload)"),U=(T=O.target)===null||T===void 0?void 0:T.result,A=S.type,o=S.type.split("/")[0],v&&v.readyState===WebSocket.OPEN?(E={type:o,data:{file:U,mime:A}},v.send(JSON.stringify([E])),k("[".concat(S.name,"]"))):R.ZP.error("WebSocket \u8FDE\u63A5\u672A\u5C31\u7EEA");case 5:case"end":return W.stop()}},B)}));return function(B){return m.apply(this,arguments)}}(),M.onerror=function(m){console.error("\u6587\u4EF6\u8BFB\u53D6\u9519\u8BEF (handleFileUpload):",m),R.ZP.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},console.log("\u5F00\u59CB\u8BFB\u53D6\u6587\u4EF6:",S.name),M.readAsDataURL(S);case 6:case"end":return j.stop()}},p)}),t.s();case 7:if((s=t.n()).done){l.next=11;break}return l.delegateYield(c(),"t0",9);case 9:l.next=7;break;case 11:l.next=16;break;case 13:l.prev=13,l.t1=l.catch(4),t.e(l.t1);case 16:return l.prev=16,t.f(),l.finish(16);case 19:case"end":return l.stop()}},e,null,[[4,13,16,19]])}));return function(n){return a.apply(this,arguments)}}(),Ue=function(e){try{var n,r=JSON.parse(e);if(!((n=r.message)!==null&&n!==void 0&&n.params)){console.warn("\u6536\u5230\u65E0\u6548\u6D88\u606F:",r);return}var t=r.message.params.messages||r.message.params.message;if(!Array.isArray(t)){console.warn("\u6D88\u606F\u683C\u5F0F\u9519\u8BEF:",t);return}var s=Date.now().toString(),c,h=[],l=!1,p,S=t.find(function(y){var D;return y.type==="reply"&&((D=y.data)===null||D===void 0?void 0:D.id)});if(S){var M=S.data.id,re=Ae(M);c={id:M,content:re}}var j=Y()(t),m;try{for(j.s();!(m=j.n()).done;){var B,O,T,U,A,o=m.value;if(o.type==="text"&&(B=o.data)!==null&&B!==void 0&&B.text)h.push(o.data.text);else if(o.type==="image"){var E,G,W;l=!0,(E=o.data)!==null&&E!==void 0&&E.url?p=o.data.url:(G=o.data)!==null&&G!==void 0&&G.file&&typeof o.data.file=="string"&&o.data.file.startsWith("data:")?p=o.data.file:(W=o.data)!==null&&W!==void 0&&W.file&&typeof o.data.file=="string"&&Be(o.data.file).then(function(y){if(y)Oe(s,y);else{var D=h.join(`
`).replace("[\u56FE\u7247\u52A0\u8F7D\u4E2D...]","[\u56FE\u7247\u52A0\u8F7D\u5931\u8D25]");De(s,D)}})}else if(o.type==="video"&&((O=o.data)!==null&&O!==void 0&&O.file||(T=o.data)!==null&&T!==void 0&&T.url))h.push("[\u89C6\u9891] ".concat(o.data.name||""));else if(o.type==="audio"&&((U=o.data)!==null&&U!==void 0&&U.file||(A=o.data)!==null&&A!==void 0&&A.url))h.push("[\u97F3\u9891] ".concat(o.data.name||""));else if(o.type==="file"){var Q;h.push("[\u6587\u4EF6] ".concat(((Q=o.data)===null||Q===void 0?void 0:Q.name)||""))}else o.type!=="reply"&&h.push("\u672A\u77E5\u6D88\u606F\u7C7B\u578B: ".concat(o.type))}}catch(y){j.e(y)}finally{j.f()}var P=h.join(`
`);l&&p?Le(s,P,p,c):l?Ne(s,P,c):c?Ee(P,c):N(P)}catch(y){N("\u89E3\u6790\u670D\u52A1\u5668\u6D88\u606F\u5931\u8D25: "+y),N("[\u6D88\u606F\u683C\u5F0F\u65E0\u6548]")}},Ae=function(e){var n=f.find(function(r){return r.id===e});return(n==null?void 0:n.content)||"\u539F\u6D88\u606F\u4E0D\u53EF\u7528"},k=function(e){var n=Date.now().toString();d(function(r){return[].concat(x()(r),[{role:"end",content:e,id:n}])})},N=function(e){var n=Date.now().toString();d(function(r){return[].concat(x()(r),[{role:"start",content:e,id:n}])})},Ee=function(e,n){var r=Date.now().toString();d(function(t){return[].concat(x()(t),[{role:"start",content:e,id:r,replyTo:n}])})},Pe=function(e){d(function(n){return[].concat(x()(n),[{role:"start",loading:!0,id:e}])})},Le=function(e,n,r,t){d(function(s){return[].concat(x()(s),[{role:"start",content:n,base64:r,id:e,replyTo:t}])})},Ne=function(e,n,r){d(function(t){return[].concat(x()(t),[{role:"start",content:n,loading:!0,id:e,replyTo:r}])})},Oe=function(e,n){d(function(r){return r.map(function(t){return t.id===e?F()(F()({},t),{},{base64:n,loading:!1}):t})}),te()},De=function(e,n){d(function(r){return r.map(function(t){return t.id===e?F()(F()({},t),{},{content:n,loading:!1}):t})})},He=function(e){d(function(n){return n.map(function(r){return r.id===e?F()(F()({},r),{},{content:"\u56FE\u7247\u52A0\u8F7D\u5931\u8D25",loading:!1}):r})})},Ve=function(e){d(function(n){return[].concat(x()(n),[{role:"start",base64:e}])})},te=function(){J.current&&(J.current.scrollTop=J.current.scrollHeight)},we=function(e){e.trim()&&(v&&v.readyState===WebSocket.OPEN?(k(e),v.send(JSON.stringify([{type:"text",data:{text:e}}])),ne(""),setTimeout(function(){},10)):R.ZP.error("WebSocket \u672A\u8FDE\u63A5"))};return(0,u.jsx)(K.Z,{spinning:Fe,tip:"websocket\u8FDE\u63A5\u4E2D...",size:"large",children:(0,u.jsxs)(de.Z,{className:z.chatCard,ref:_,children:[(0,u.jsx)("div",{className:z.chatContainer,ref:J,children:f.map(function(a,e){return(0,u.jsx)(fe.Z,{placement:a.role,shape:"corner",className:z.message,messageRender:function(){return(0,u.jsx)(ge,{content:a.content,base64:a.base64,loading:a.loading,replyTo:a.replyTo})}},e)})}),(0,u.jsx)(ve.Z,{placeholder:"\u8BF7\u8F93\u5165...",className:z.bottomTools,value:Ze,autoSize:!0,onChange:function(e){ne(e)},onSubmit:function(e){we(e)},prefix:(0,u.jsx)(u.Fragment,{children:(0,u.jsx)(pe.Z,{beforeUpload:function(){return!1},onChange:function(e){if(!e.file.originFileObj){console.error("\u6587\u4EF6\u5BF9\u8C61\u4E0D\u5B58\u5728"),R.ZP.error("\u6587\u4EF6\u4E0A\u4F20\u5931\u8D25\uFF1A\u65E0\u6CD5\u83B7\u53D6\u6587\u4EF6");return}var n=e.file.originFileObj;console.log("\u6587\u4EF6\u4E0A\u4F20:",n.name,n.type);var r=new FileReader;r.onload=function(t){var s;console.log("\u6587\u4EF6\u8BFB\u53D6\u5B8C\u6210");var c=(s=t.target)===null||s===void 0?void 0:s.result,h=n.type,l=n.type.split("/")[0];if(v&&v.readyState===WebSocket.OPEN){var p;l==="image"?p={type:l,data:{url:c,file:n.name}}:l==="video"||l==="audio"?p={type:l,data:{file:c}}:p={type:"file",data:{name:n.name,content:c}},v.send(JSON.stringify([p])),k("[".concat(n.name,"]"))}else R.ZP.error("WebSocket \u8FDE\u63A5\u672A\u5C31\u7EEA")},r.onerror=function(t){console.error("\u6587\u4EF6\u8BFB\u53D6\u9519\u8BEF:",t),R.ZP.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},r.readAsDataURL(n)},getDropContainer:function(){return _.current},maxCount:5,multiple:!0,showUploadList:!1,placeholder:{icon:(0,u.jsx)(I.Z,{}),title:"\u677E\u5F00\u4E0A\u4F20",description:"\u652F\u6301\u6587\u4EF6\uFF1A\u56FE\u7247\u3001\u89C6\u9891\u3001\u97F3\u9891\u7B49"},children:(0,u.jsx)(ce.ZP,{type:"text",icon:(0,u.jsx)(I.Z,{})})})})})]})})},xe=je}}]);
