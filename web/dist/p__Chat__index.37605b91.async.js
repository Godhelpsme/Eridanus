"use strict";(self.webpackChunkant_design_pro=self.webpackChunkant_design_pro||[]).push([[570],{28650:function(qe,pe,l){l.r(pe),l.d(pe,{default:function(){return Je}});var Me=l(97857),O=l.n(Me),Re=l(19632),Z=l.n(Re),Ce=l(64599),he=l.n(Ce),we=l(15009),w=l.n(we),Ee=l(99289),X=l.n(Ee),Fe=l(5574),P=l.n(Fe),E=l(67294),B=l(2453),oe=l(74330),ge=l(4393),Te=l(83622),xe=l(16596),De=l(76654),Be=l(45311),Ae=l(73869),me=l(76772),ye=l(71471),ie=l(2487),Ze=l(95715),We=l(42075),_e=l(9669),n=l(85893),et=function(r){var g=Typography.Text,f=Typography.Title,u=useState({name:"\u52A0\u8F7D\u4E2D...",artists:"",picUrl:""}),p=_slicedToArray(u,2),R=p[0],a=p[1],x=useState(!0),d=_slicedToArray(x,2),S=d[0],_=d[1],z=useState(!1),j=_slicedToArray(z,2),ee=j[0],$=j[1];return useEffect(function(){var te=function(){var se=_asyncToGenerator(_regeneratorRuntime().mark(function L(){var G,N,re,A,T,J;return _regeneratorRuntime().wrap(function(m){for(;;)switch(m.prev=m.next){case 0:if(m.prev=0,N=(G=r.split("id=")[1])===null||G===void 0?void 0:G.split(".")[0],N){m.next=5;break}return $(!0),m.abrupt("return");case 5:return m.next=7,axios.get("https://music.163.com/api/song/detail?ids=[".concat(N,"]"));case 7:re=m.sent,A=re.data,A.code===200&&A.songs&&A.songs.length>0?(T=A.songs[0],J=T.artists.map(function(le){return le.name}).join(", "),a({name:T.name,artists:J,picUrl:T.album.picUrl})):$(!0),m.next=16;break;case 12:m.prev=12,m.t0=m.catch(0),console.error("\u83B7\u53D6\u97F3\u4E50\u4FE1\u606F\u5931\u8D25:",m.t0),$(!0);case 16:return m.prev=16,_(!1),m.finish(16);case 19:case"end":return m.stop()}},L,null,[[0,12,16,19]])}));return function(){return se.apply(this,arguments)}}();te()},[r]),_jsx(Card,{style:{width:300,marginTop:10},loading:S,children:!S&&!ee?_jsxs("div",{style:{display:"flex",alignItems:"center"},children:[_jsx(Image,{src:R.picUrl,width:64,height:64,style:{borderRadius:"4px"},preview:!1}),_jsxs("div",{style:{marginLeft:12,flex:1},children:[_jsx(f,{level:5,style:{margin:0},children:R.name}),_jsx(g,{type:"secondary",children:R.artists}),_jsx("audio",{src:r,controls:!0,style:{width:"100%",marginTop:8}})]})]}):ee?_jsxs("div",{children:[_jsx(g,{type:"danger",children:"\u65E0\u6CD5\u52A0\u8F7D\u97F3\u4E50\u4FE1\u606F"}),_jsx("audio",{src:r,controls:!0,style:{width:"100%",marginTop:8}})]}):null})},Se=function(r){var g=ye.Z.Text,f=ye.Z.Title;if(!r)return(0,n.jsx)("div",{children:"\u8F6C\u53D1\u6D88\u606F\u6570\u636E\u65E0\u6548"});var u=[],p="\u8F6C\u53D1\u6D88\u606F";return r.message&&r.message.params&&r.message.params.messages?(u=r.message.params.messages,u.length>0&&u[0].data&&u[0].data.nickname&&(p=u[0].data.nickname)):r.data&&r.data.content?(u=[{data:{content:r.data.content}}],r.data.nickname&&(p=r.data.nickname)):Array.isArray(r)&&(u=r),u.length===0?(0,n.jsx)("div",{children:"\u8F6C\u53D1\u6D88\u606F\u6570\u636E\u65E0\u6548"}):(0,n.jsx)(ge.Z,{title:p,style:{marginTop:10,maxWidth:"100%",backgroundColor:"#f9f9f9"},size:"small",bordered:!0,children:(0,n.jsx)(ie.Z,{itemLayout:"vertical",dataSource:u,renderItem:function(a){if(a.type==="node"&&a.data){var x=a.data.content||[];return(0,n.jsxs)(ie.Z.Item,{children:[a.data.nickname&&(0,n.jsx)("div",{style:{fontWeight:"bold",marginBottom:"4px"},children:a.data.nickname}),x.map(function(d,S){return d.type==="text"&&d.data&&d.data.text?(0,n.jsx)("div",{style:{whiteSpace:"pre-wrap",fontSize:"14px"},children:d.data.text},S):null})]})}else if(a.type==="text"&&a.data&&a.data.text)return(0,n.jsx)(ie.Z.Item,{children:(0,n.jsx)("div",{style:{whiteSpace:"pre-wrap",fontSize:"14px"},children:a.data.text})});return null},split:!0})})},ke=function(r,g,f){if(g==="node"&&f)return Se(f);var u={image:(0,n.jsx)(Ze.Z,{src:r,style:{maxWidth:"150px",cursor:"pointer"}}),video:(0,n.jsx)("video",{src:r,controls:!0,style:{maxWidth:"300px"}}),record:(0,n.jsx)("audio",{src:r,controls:!0,style:{width:"200px"}}),node:f?Se(f):(0,n.jsx)("div",{children:"\u8F6C\u53D1\u6D88\u606F\u6570\u636E\u65E0\u6548"}),music:(0,n.jsx)("div",{children:"[\u97F3\u4E50\u5361\u7247\uFF0C\u6682\u4E0D\u652F\u6301]"}),text:null};return u[g]||(0,n.jsx)("div",{children:"\u4E0D\u652F\u6301\u7684\u5A92\u4F53\u7C7B\u578B"})},Oe=function(r){var g,f=r.content,u=r.url,p=r.type,R=r.loading,a=r.replyTo,x=r.nodeData,d=(0,me.useModel)("@@initialState"),S=d.initialState,_=d.setInitialState,z=S==null||(g=S.settings)===null||g===void 0?void 0:g.isDark;return(0,n.jsxs)("div",{children:[a!=null&&a.content?(0,n.jsx)("div",{style:{padding:"5px",backgroundColor:"#f0f0f0",borderRadius:"4px",marginBottom:"8px",fontSize:"12px",color:"#666"},children:(0,n.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"8px"},children:a.content.length>50?"".concat(a.content.substring(0,50),"..."):a.content})}):null,f?"".concat(f):"",R?(0,n.jsx)("div",{style:{padding:"10px",textAlign:"center"},children:(0,n.jsxs)(We.Z,{children:[(0,n.jsx)(oe.Z,{size:"small"}),(0,n.jsx)("span",{children:"\u52A0\u8F7D\u4E2D..."})]})}):u&&p!="text"?(0,n.jsx)("div",{children:ke(u,p,x)}):""]})},Le=Oe,Ne="chatMessagesDB",Ue=1,q="messages",Ie=function(){return new Promise(function(r,g){var f=indexedDB.open(Ne,Ue);f.onerror=function(u){console.error("\u6570\u636E\u5E93\u6253\u5F00\u5931\u8D25:",u),g("\u6570\u636E\u5E93\u6253\u5F00\u5931\u8D25")},f.onsuccess=function(u){var p=u.target.result;r(p)},f.onupgradeneeded=function(u){var p=u.target.result;p.objectStoreNames.contains(q)||p.createObjectStore(q,{keyPath:"id"})}})},Pe=function(){var F=X()(w()().mark(function r(g){var f,u,p;return w()().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,Ie();case 3:return f=a.sent,u=f.transaction([q],"readwrite"),p=u.objectStore(q),p.clear(),g.forEach(function(x){p.add(x)}),a.abrupt("return",new Promise(function(x,d){u.oncomplete=function(){f.close(),x()},u.onerror=function(S){console.error("\u4FDD\u5B58\u6D88\u606F\u5931\u8D25:",S),d("\u4FDD\u5B58\u6D88\u606F\u5931\u8D25")}}));case 11:throw a.prev=11,a.t0=a.catch(0),console.error("\u4FDD\u5B58\u6D88\u606F\u65F6\u51FA\u9519:",a.t0),a.t0;case 15:case"end":return a.stop()}},r,null,[[0,11]])}));return function(g){return F.apply(this,arguments)}}(),tt=null,rt=null,ze="/api/ws",$e="",Ge=function(){var r,g=(0,me.useModel)("@@initialState"),f=g.initialState,u=g.setInitialState,p=f==null||(r=f.settings)===null||r===void 0?void 0:r.isDark,R=(0,E.useState)([]),a=P()(R,2),x=a[0],d=a[1],S=(0,E.useRef)([]),_=(0,E.useState)(null),z=P()(_,2),j=z[0],ee=z[1],$=E.useState(!1),te=P()($,2),se=te[0],L=te[1],G=E.useState(!0),N=P()(G,2),re=N[0],A=N[1],T=(0,E.useRef)(null),J=E.useRef(null),je=(0,E.useState)(""),m=P()(je,2),le=m[0],ue=m[1],nt=function(){console.log("Current messages:",x),x.forEach(function(t,e){console.log("Message ".concat(e,":"),t)})};(0,E.useEffect)(function(){var o=function(){var t=X()(w()().mark(function e(){return w()().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:A(!0);try{}catch(v){console.error("\u52A0\u8F7D\u5386\u53F2\u6D88\u606F\u5931\u8D25:",v)}finally{A(!1),L(!0),He()}case 2:case"end":return s.stop()}},e)}));return function(){return t.apply(this,arguments)}}();return o(),function(){j&&j.close()}},[]),(0,E.useEffect)(function(){be(),S.current=x,x.length>0&&Pe(x).catch(function(o){console.error("\u4FDD\u5B58\u6D88\u606F\u5230IndexedDB\u5931\u8D25:",o)})},[x]);var He=function o(){var t=new WebSocket("".concat($e).concat(ze,"?auth_token=").concat(localStorage.getItem("auth_token")));t.onopen=function(){L(!1),B.ZP.success("WebSocket \u5DF2\u8FDE\u63A5\uFF01")},t.onmessage=function(e){Ve(e.data)},t.onclose=function(){window.location.pathname=="/chat"&&(L(!0),setTimeout(o,5e3))},t.onerror=function(e){B.ZP.error("WebSocket \u8FDE\u63A5\u9519\u8BEF")},ee(t)},at=function(){var o=X()(w()().mark(function t(e){var i,s,v,h;return w()().wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(i=e.target.files,!(!i||i.length===0)){c.next=3;break}return c.abrupt("return");case 3:s=he()(i),c.prev=4,h=w()().mark(function C(){var y,D;return w()().wrap(function(U){for(;;)switch(U.prev=U.next){case 0:y=v.value,D=new FileReader,D.onload=function(){var W=X()(w()().mark(function I(V){var M,Y,K,ne,ae;return w()().wrap(function(k){for(;;)switch(k.prev=k.next){case 0:console.log("\u6587\u4EF6\u8BFB\u53D6\u5B8C\u6210 (handleFileUpload)"),Y=(M=V.target)===null||M===void 0?void 0:M.result,K=y.type,ne=y.type.split("/")[0],j&&j.readyState===WebSocket.OPEN?(ae={type:ne,data:{file:Y,mime:K}},j.send(JSON.stringify([ae])),ce("[".concat(y.name,"]"),Date.now())):B.ZP.error("WebSocket \u8FDE\u63A5\u672A\u5C31\u7EEA");case 5:case"end":return k.stop()}},I)}));return function(I){return W.apply(this,arguments)}}(),D.onerror=function(W){console.error("\u6587\u4EF6\u8BFB\u53D6\u9519\u8BEF (handleFileUpload):",W),B.ZP.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},console.log("\u5F00\u59CB\u8BFB\u53D6\u6587\u4EF6:",y.name),D.readAsDataURL(y);case 6:case"end":return U.stop()}},C)}),s.s();case 7:if((v=s.n()).done){c.next=11;break}return c.delegateYield(h(),"t0",9);case 9:c.next=7;break;case 11:c.next=16;break;case 13:c.prev=13,c.t1=c.catch(4),s.e(c.t1);case 16:return c.prev=16,s.f(),c.finish(16);case 19:case"end":return c.stop()}},t,null,[[4,13,16,19]])}));return function(e){return o.apply(this,arguments)}}(),Ve=function(t){try{var e,i=JSON.parse(t);if(!((e=i.message)!==null&&e!==void 0&&e.params)){console.warn("\u6536\u5230\u65E0\u6548\u6D88\u606F:",i);return}var s=i.message.params.message;if(!Array.isArray(s)){console.warn("\u6D88\u606F\u683C\u5F0F\u9519\u8BEF:",s);return}var v=Date.now(),h,b=[],c=!1,C,y,D,H=he()(s),U;try{for(H.s();!(U=H.n()).done;){var W,I,V,M=U.value;y=M.type;var Y=(W=M.data)===null||W===void 0?void 0:W.text,K=(I=M.data)===null||I===void 0?void 0:I.id;if(C=(V=M.data)===null||V===void 0?void 0:V.file,y==="reply"){var ne=Ye(K);h={id:K,content:ne};continue}else if(y==="node")D=M,c=!0,b.push("[\u8F6C\u53D1\u6D88\u606F]");else if(y==="text"&&Y)b.push(Y);else if(y&&y!=="text"&&(c=!0,b.length===0&&b.push("[\u52A0\u8F7D\u4E2D...]"),C&&fe(v,b.join(`

`),"/api/chat/file?path=".concat(C),y,h,D),M.data&&M.data.type==="163")){var ae="https://music.163.com/song/media/outer/url?id=".concat(M.data.id,".mp3");Qe(v,b.join(`
`),ae,"music",h)}}}catch(k){H.e(k)}finally{H.f()}var Q=b.join(`
`);c&&D?fe(v,Q,"","node",h,D):c?fe(v,Q,C||"",y||"",h):h?Ke(v,Q,y||"text",h):de(v,Q)}catch(k){de(1,"\u89E3\u6790\u670D\u52A1\u5668\u6D88\u606F\u5931\u8D25: "+k),de(1,"[\u6D88\u606F\u683C\u5F0F\u65E0\u6548]")}},Ye=function(t){var e=S.current.find(function(s){return s.id==t});if(console.log("\u56DE\u590D\u7684\u6D88\u606Fid:".concat(t,",\u5185\u5BB9:"),JSON.stringify(e,null,2)),e!=null&&e.content)return e==null?void 0:e.content;if(e!=null&&e.type){var i={image:"[\u56FE\u7247]",node:"[\u8F6C\u53D1\u6D88\u606F]",music:"[\u97F3\u4E50]",audio:"[\u8BED\u97F3]",video:"[\u89C6\u9891]",file:"[\u6587\u4EF6]"};return"[".concat(i[e.type],"]")}return"\u539F\u6D88\u606F\u4E0D\u53EF\u7528"},ce=function(t,e){console.log("\u7528\u6237\u6D88\u606Fid:".concat(e,",\u5185\u5BB9:").concat(t)),d(function(i){return[].concat(Z()(i),[{role:"end",content:t,id:e,type:"text"}])})},de=function(t,e){d(function(i){return[].concat(Z()(i),[{role:"start",content:e,id:t,type:"text"}])})},Ke=function(t,e,i,s){d(function(v){return[].concat(Z()(v),[{role:"start",content:e,id:t,type:i,replyTo:s}])})},ot=function(t){d(function(e){return[].concat(Z()(e),[{role:"start",loading:!0,id:t}])})},fe=function(t,e,i,s,v,h){d(function(b){return[].concat(Z()(b),[{role:"start",content:e,url:i,type:s,id:t,replyTo:v,nodeData:h}])})},Qe=function(t,e,i,s,v,h){d(function(b){return[].concat(Z()(b),[{role:"start",content:e,url:i,type:s,loading:!0,id:t,replyTo:v,nodeData:h}])})},it=function(t,e,i,s){d(function(v){return v.map(function(h){return h.id===t?O()(O()({},h),{},{url:e,type:i,loading:!1,nodeData:s}):h})}),be()},st=function(t,e){d(function(i){return i.map(function(s){return s.id===t?O()(O()({},s),{},{content:e,loading:!1,id:t}):s})})},lt=function(t){d(function(e){return e.map(function(i){return i.id===t?O()(O()({},i),{},{content:"\u56FE\u7247\u52A0\u8F7D\u5931\u8D25",loading:!1,id:t}):i})})},ut=function(t){d(function(e){return[].concat(Z()(e),[{role:"start",url:t}])})},be=function(){T.current&&(T.current.scrollTop=T.current.scrollHeight)},Xe=function(t){if(t.trim())if(j&&j.readyState===WebSocket.OPEN){var e=Date.now();ce(t,e),j.send(JSON.stringify({type:"text",id:e,isat:!0,data:{text:t}})),ue(""),setTimeout(function(){},10)}else B.ZP.error("WebSocket \u672A\u8FDE\u63A5")},ve={container:{top:0,display:"flex",justifyContent:"center",alignItems:"center",overflow:"hidden"},chatCard:{width:"100%",height:"calc(100vh-100px)",display:"flex",flexDirection:"column"},chatContainer:{position:"relative",display:"flex",flexDirection:"column",padding:"8px",borderRadius:"10px",height:"auto",marginBottom:"60px",overflowY:"auto"},message:{borderRadius:"1px",wordWrap:"break-word",margin:"10px 0",position:"relative"},userMessage:{marginLeft:"20%",background:"#1890ff",color:"white",borderBottomRightRadius:"4px"},serverMessage:{marginRight:"20%",background:"#f0f0f0",color:"#333",borderBottomLeftRadius:"4px"},bottomTools:{position:"absolute",left:"0",bottom:"0px",backgroundColor:p?"#2e2e2e":"#fff",maxHeight:"90vh",overflowY:"auto"},uploadButton:{flexShrink:0},sendButton:{flexShrink:0}};return(0,n.jsx)(oe.Z,{spinning:se,tip:"websocket\u8FDE\u63A5\u4E2D...",size:"large",children:(0,n.jsx)(ge.Z,{style:{height:"calc(100vh - 100px)"},children:(0,n.jsxs)("div",{ref:J,style:{width:"100%",height:"calc(100vh - 100px)",display:"flex",flexDirection:"column"},children:[(0,n.jsx)("div",{style:ve.chatContainer,ref:T,children:re?(0,n.jsx)("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:(0,n.jsx)(oe.Z,{tip:"\u52A0\u8F7D\u5386\u53F2\u6D88\u606F\u4E2D...",size:"large"})}):x.map(function(o,t){return(0,n.jsx)(De.Z,{placement:o.role,shape:"corner",style:ve.message,messageRender:function(){return(0,n.jsx)(Le,{content:o.content,url:o.url,type:o.type,loading:o.loading,replyTo:o.replyTo,nodeData:o.nodeData})}},t)})}),(0,n.jsx)(Be.Z,{placeholder:"\u8BF7\u8F93\u5165...",style:ve.bottomTools,value:le,autoSize:!0,onChange:function(t){ue(t)},onSubmit:function(t){ue(""),Xe(t)},prefix:(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(Ae.Z,{beforeUpload:function(){return!1},onChange:function(t){if(!t.file.originFileObj){console.error("\u6587\u4EF6\u5BF9\u8C61\u4E0D\u5B58\u5728"),B.ZP.error("\u6587\u4EF6\u4E0A\u4F20\u5931\u8D25\uFF1A\u65E0\u6CD5\u83B7\u53D6\u6587\u4EF6");return}var e=t.file.originFileObj;console.log("\u6587\u4EF6\u4E0A\u4F20:",e.name,e.type);var i=new FileReader;i.onload=function(s){var v;console.log("\u6587\u4EF6\u8BFB\u53D6\u5B8C\u6210");var h=(v=s.target)===null||v===void 0?void 0:v.result,b=e.type,c=e.type.split("/")[0];if(j&&j.readyState===WebSocket.OPEN){var C;c==="image"?C={type:c,data:{url:h,file:e.name}}:c==="video"||c==="audio"?C={type:c,data:{file:h}}:C={type:"file",data:{name:e.name,content:h}},j.send(JSON.stringify(C)),ce("[".concat(e.name,"]"),Date.now())}else B.ZP.error("WebSocket \u8FDE\u63A5\u672A\u5C31\u7EEA")},i.onerror=function(s){console.error("\u6587\u4EF6\u8BFB\u53D6\u9519\u8BEF:",s),B.ZP.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},i.readAsDataURL(e)},getDropContainer:function(){return J.current},maxCount:5,multiple:!0,showUploadList:!1,placeholder:{icon:(0,n.jsx)(xe.Z,{}),title:"\u677E\u5F00\u4E0A\u4F20",description:"\u5F53\u524D\u4EC5\u652F\u6301\u56FE\u7247"},children:(0,n.jsx)(Te.ZP,{type:"text",icon:(0,n.jsx)(xe.Z,{})})})})})]})},"aaaaa")})},Je=Ge}}]);
